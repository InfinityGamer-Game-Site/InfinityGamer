(function(){function qb(a){a._listNext=a;a._listPrev=a}function rb(a,b){b._listNext=a;a._listPrev._listNext=b;b._listPrev=a._listPrev;a._listPrev=b}function vc(a,b){b._listNext=a._listNext;a._listNext._listPrev=b;b._listPrev=a;a._listNext=b}function ea(a){a._listNext&&(a._listNext._listPrev=a._listPrev,a._listPrev._listNext=a._listNext,a._listNext=null,a._listPrev=null)}function wc(a){a=a._listPrev;a._listNext._listPrev=a._listPrev;a._listPrev._listNext=a._listNext;return a}function Qb(a,b,e){ab();
$.ajax(a,{success:function(a){bb();e||"string"!==typeof a||(a=JSON.parse(a));b(a)},error:function(a){throw Error(JSON.stringify(a));}})}function E(a){return a[u(a.length)]}function Fa(a){var b=Math.floor(u(a.length)),e=a[b];a.splice(b,1);return e}function Ga(a,b){var e=a.indexOf(b);0<=e&&a.splice(e,1)}function V(a){a.stopPropagation();a.preventDefault()}function va(a){if(0==a)return"- - -";var b=0>a;b&&(a=-a);a=a.toString();for(var e="";0<a.length;){""!=e&&(e=","+e);var d=Math.max(0,a.length-3),e=
a.substring(d)+e;a=a.substr(0,d)}return b?"-"+e:e}function wa(a,b){a.hasOwnProperty("itemsToDrop")||(a.itemsToDrop=[]);a.itemsToDrop&&a.itemsToDrop.push(b)}function xc(a){var b=a.tile||a;if(a.hasOwnProperty("itemsToDrop")&&a.itemsToDrop)for(;a.itemsToDrop.length;){var e=a.itemsToDrop.pop();ia(e);e.dropped(b)}}function W(a,b){return cb&&cb.hasOwnProperty(a)?cb[a]:b}function yc(){K=H("currentLevel",!1);!1===K&&(zb(),Ab.newGame(),K=0);fa=H("playersAttempt");(db=H("attemptCommited"))&&3<K&&(fa++,fa>Ha&&
(zb(),fa=1),z("playersAttempt",fa),z("attemptCommited",!1),db=!1,eb());K=H("currentLevel");Rb=H("playerSeed");Pa=H("xp");oa=H("playersLevel");fb=H("xpToNextLevel");ha=H("playersGold");gb=H("playersAttack");sb=H("playersDefence");Qa=H("playersMaxHp");xa=H("playersLookDist");Ra=H("playersCapacity");Sa=H("spearThroughting");g.transform=H("transform")}function zc(a){a&&(Ta.push(a),a.visible=!0,a.explored||(a.explored=!0,a.up&&(a.up.updateFog(),a.up.left&&a.up.left.updateFog(),a.up.right&&a.up.right.updateFog()),
a.down&&(a.down.updateFog(),a.down.left&&a.down.left.updateFog(),a.down.right&&a.down.right.updateFog()),a.left&&a.left.updateFog(),a.right&&a.right.updateFog()))}function bd(a){return!a.wall&&1!==a.grass&&!a.door}function cd(a){return!a.wall}function J(a,b){return a&&!a.wall&&(!b||(!a.unit||1===a.team)&&a.explored)}function L(a){return a&&a.wall}function Ac(a){var b=pa/2/h;y=ya/2/h-a.x;w=b-a.y}function tb(){this.y-=.5;switch(this.phase&31){case 0:this.x++;break;case 16:this.x--}this.phase--;return 0>=
this.phase}function dd(){this.phase--;return 0>=this.phase?!0:0>=this.unit.hp}function ed(){this.y+=.5;this.phase--;return 0>=this.phase}function Bc(){this.y-=.1;switch(this.phase&15){case 0:this.x++;break;case 16:this.x--}this.phase-=.4;return 0>=this.phase}function fd(){p.fillStyle="#fff";var a=Math.sin(this.phase/9),b=Math.cos(this.phase/9);p.fillRect((this.unit.x+8+4*a+y)*h,(this.unit.y+this.unit.uih+b+w)*h,2*h,2*h);p.fillRect((this.unit.x+8+-4*a+y)*h,(this.unit.y+this.unit.uih-b+w)*h,2*h,2*h)}
function Bb(){p.fillStyle="#f"+Math.ceil(this.phase/2)+"0";p.fillRect((this.x+y)*h,(this.y+w)*h,this.phase/6*h,this.phase/4*h)}function gd(){p.fillStyle="#a70";p.fillRect((this.x+y)*h,(this.y+w)*h,this.phase/6*h,this.phase/4*h)}function hd(){p.fillStyle="rgba(0,180,0,0.6)";p.fillRect((this.x+y)*h,(this.y+w)*h,this.phase/6*h,this.phase/4*h)}function Ua(){p.fillStyle="#eee";p.fillRect((this.x+y)*h,(this.y+w)*h,this.phase/3*h,this.phase/3*h)}function Cc(){p.fillStyle="#000";p.fillRect((this.x+y)*h,(this.y+
w)*h,this.phase/3*h,this.phase/3*h)}function Ia(){this.x+=this.xs;this.y+=this.ys;this.ys+=.2;this.xs*=.98;this.ys*=.98;--this.phase;return 0>=this.phase}function Sb(){p.fillStyle="#a00";p.fillRect((this.x+y)*h,(this.y+w)*h,this.phase/6*h,this.phase/4*h)}function Cb(){this.x+=this.xs;this.y+=this.ys;Tb&&(this.phase-=2);return 0>=this.phase}function Va(a,b){0>=b||!a||!a.unit||(X(a.unit,"poison",b),a.unit.say(m("poisoned"),"#a00"))}function Ub(a,b){void 0===b&&(b=1);return function(e,d){(6===e.mat1.t||
6===e.mat2.t)&&0<d&&u(100)<a&&Va(e.tile,u(b)+2)}}function Dc(a,b){void 0===b&&(b=1);return function(e,d){0<d&&u(100)<a&&(X(e,"paralize",u(b)+2),e.say(m("paralized"),"#a80"))}}function Ec(a,b){void 0===b&&(b=1);return function(b,d){0<d&&u(100)<a&&(b.say(m("crit"),"#f00"),b.damage(d))}}function t(a,b){void 0===b&&(b=1);return"broken"===a.mat1.key||"broken"===a.mat2.key?0:Math.round(Math.sqrt(a.getValue())/3*b)+a.getGrade()}function Vb(a,b,e,d,c,k){if(b=x.getClosestEnemy(b.x,b.y,e,16))if(b.damage(a,
d,c,this),k&&0<b.hp)return wa(b,k),!0}function Wb(a,b){var e=10;a+=8;for(b+=8;0<e;){var d=Math.sin(e),c=Math.cos(e),k=M(a+d,b+d,Ia,Ua);k.xs=d;k.ys=c;e--}}function Db(a,b){a&&a.unit&&(X(a.unit,"stun",60*b||200),a.unit.say(m("stunned"),"#a80"))}function Fc(){Ab.levelComplete(K);K++;Gc(g.instance);hb=!0}function ub(a,b,e){var d=0;a.forEachVisibleTile(10,function(c){if(d<e)c.wall||c.team||(c=Wa(c,b),c.x=a.x,c.y=a.y,c.sleep=!1,d++);else return!0})}function id(a,b){if(!this.comedBack&&a.tile&&!a.tile.wall){var e=
x.getTile(this.x+2*(a.tile.x-this.tile.x)+8,this.y+2*(a.tile.y-this.tile.y)+8);!e||e.wall||e.unit||(this.setTile(e),this.comedBack=!0)}}var Ab;(function(){Ab={levelComplete:function(b){a("level","LevelComplete_"+b)},newGame:function(){a("level","NewGame")}};var a=function(a,e){try{ga("send","event",a,e)}catch(d){}};(function(a,e,d,c,k,n,g){a.GoogleAnalyticsObject=k;a[k]=a[k]||function(){(a[k].q=a[k].q||[]).push(arguments)};a[k].l=1*new Date;n=e.createElement(d);g=e.getElementsByTagName(d)[0];n.async=
1;n.src=c;g.parentNode.insertBefore(n,g)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create","UA-85621764-1","auto");ga("send","pageview")})();"use strict";"use strict";var Xb,u,Hc,Ic,za=2*Math.PI,Eb=2*Math.PI/3,ab,bb,Yb,Ja,H,z,Zb,eb,Jc;(function(){var a=0;ab=function(){a++;if(1===a){var c=document.getElementById("wait-fader");c&&(c.className="show-fader")}};bb=function(){a--;if(0===a){$(".bg *").each(function(){$(this).hasClass("loading")||$(this).remove()});
var c=document.getElementById("wait-fader");c&&(c.className="")}};Yb=function(){return 0<a};Ja=function(){return Yb()||r.isPauseNeed()};var b=1E7*Math.random()+(new Date).getTime();u=function(c){b=33*b+831;b%=12147483647;return void 0!==c?Math.ceil(b/491)%c:Math.ceil(b/493)};Xb=function(c){b=c};var e;Hc=function(c){e=c};Ic=function(c,a){c+=e;a+=e;var d=(52.3944*c+34.7343*a)%2-1;c/=15;a/=15;var b=c%1,k=a%1;c=Math.floor(c);a=Math.floor(a);return(128.3944*c%10*b+128.3944*(c+1)%10*(1-b)+171.7343*a%10*
k+171.7343*(a+1)%10*(1-k)+1231)%10+d};var d=function(c,a){try{if("undefined"!==typeof Storage&&localStorage.hasOwnProperty(c))return JSON.parse(localStorage[c])}catch(S){}return a},c=function(c,a){for(var d=[],b=0,e,k="",n=0;256>n;n++)d[n]=n;for(n=0;256>n;n++)b=(b+d[n]+c.charCodeAt(n%c.length))%256,e=d[n],d[n]=d[b],d[b]=e;for(var g=b=n=0;g<a.length;g++)n=(n+1)%256,b=(b+d[n])%256,e=d[n],d[n]=d[b],d[b]=e,k+=String.fromCharCode(a.charCodeAt(g)^d[(d[n]+d[b])%256]);return k},k;try{k=JSON.parse(c("IUgqwiuIUYFqwiuyqiuwdoiugy&129871GEI9(&*^gps!()8",
d("undefined_")))}catch(n){}k||(k={});H=function(c,a){return k.hasOwnProperty(c)?k[c]:a};z=function(c,a){k[c]=a};Zb=function(c){delete k[c]};eb=function(){var a=c("IUgqwiuIUYFqwiuyqiuwdoiugy&129871GEI9(&*^gps!()8",JSON.stringify(k));try{"undefined"!==typeof Storage&&localStorage.setItem("undefined_",JSON.stringify(a))}catch(F){}};Jc=function(){return k}})();Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(a,b){if(null==this)throw new TypeError('"this" is null or not defined');
var e=Object(this),d=e.length>>>0;if("function"!==typeof a)throw new TypeError("predicate must be a function");for(var c=0;c<d;){var k=e[c];if(a.call(b,k,c,e))return k;c++}}});"use strict";var f,Kc,Lc;(function(){var a=[];Kc=function(c){a.push(c)};Lc=function(){a.some(function(c){c()})};var b,e,d,c=[],k=[],n=[],g=[],h=[];f={img:function(c,a,d,e){var k=c+"-"+a.key+"-"+d.key;e&&(k+="#");k in n||(n[k]=this.imgFromData(b[c].pic,a,d,e));return n[k]},imgRandomId:function(c){return E(b.filter(function(a){return a.t===
c})).id},mat:function(c){return e[c]},matRandom:function(c,a,b){return E(d.filter(function(d){return d.lvl<=K&&(!b||d.t===b)&&d.price<=a&&d.price>=c}))},f1s:function(c){return f.mat(c).lvl<=K},filterMatList:function(c){return c=c.filter(this.f1s)},wallMat:function(){return this.matRandom(1,4)},imgFromData:function(c,a,d,b){var e=document.createElement("canvas");e.width=16;e.height=16;var k=e.getContext("2d"),n=k.getImageData(0,0,16,16),g=0,f;d=[a,d];var h,F=n.data;for(a=0;a<c.length;a++)f=c.charCodeAt(a),
32!==f?(f-=48,h=d[f>>2],f&=3,b&&3!==f&&96>a&&(f=80>a?1:2==f?0:1),f=h.colors[f],F[g++]=f[0],F[g++]=f[1],F[g++]=f[2],F[g++]=f[3]):g+=4;k.putImageData(n,0,0);return e},mat1amount:function(c){return g[c]},mat2amount:function(c){return h[c]},clearCache:function(){n=[]},fog:function(c){return k[c]},thinFog:function(a){return c[a]}};Qb("data/materials.JSON",function(c){e=c;d=[];for(var a in e)c=e[a],c.key=a,d.push(c)});Qb("data/images.JSON",function(c){b=c;c.some(function(c,a){c.id=a;if(c.r){for(var d="",
e=0;256>e;e+=16)d+=c.pic.substr(e,16).split("").reverse().join("");b[a+"r"]={pic:d}}d=c.pic.match(/[0-2]/g);g[a]=d?d.length:0;d=c.pic.match(/[4-6]/g);h[a]=d?d.length:0});f.imagesCount=c.length});ab();var m=new Image,ca;f.setFogColor=function(a,d,b,e){var n=a+d+b+e;if(ca!==n){ca=n;n=document.createElement("canvas");n.width=m.width;n.height=m.height;n=n.getContext("2d");n.drawImage(m,0,0);for(var g,f=0;256>f;f++){var h=document.createElement("canvas");h.width=16;h.height=16;var F=h.getContext("2d");
g=n.getImageData(16*(f&15),16*(f>>4),16,16);F.putImageData(g,0,0);c[f]=h;h=document.createElement("canvas");h.width=16;h.height=16;F=h.getContext("2d");g=n.getImageData(16*(f&15),16*(f>>4),16,16);for(var S=g.data,T=0;T<S.length;T+=4)S[T]=a,S[T+1]=d,S[T+2]=b,S[T+3]*=e;F.putImageData(g,0,0);k[f]=h}}};m.onload=function(){bb()};m.src="data/fog.png";ab();f.backgroundImg=new Image;f.backgroundImg.onload=function(){bb()};f.backgroundImg.src="data/yard.png";ab();f.treeImg=new Image;f.treeImg.onload=function(){bb()};
f.treeImg.src="data/tree.png"})();"use strict";var B;(function(){B=function(c){this.lockedTile=!0;c&&(this.x=c.x,this.y=c.y,this.setTile(c),this.visible=!0)};B.prototype.onFire=function(c){if(this.mat1.combustible||this.mat2.combustible)this.mat1.combustible&&(this.mat1=f.mat("cinder")),this.mat2.combustible&&(this.mat2=f.mat("cinder")),this.updateImg()};B.prototype.destroy=function(){this.setTile(null);ea(this)};B.prototype.updateImg=function(){!1!==this.img&&(this.img=this.invisible&&this.team&&
1!==this.team?void 0:this.reflect?f.img(this.imgId+"r",this.overMat||this.mat1,this.overMat||this.mat2):f.img(this.imgId,this.overMat||this.mat1,this.overMat||this.mat2))};B.prototype.addOverMat=function(c,a){this.hasOwnProperty("_overMats")||(this._overMats=[]);"undefined"===typeof a&&(a=0);var d=this._overMats.find(function(a){if(a.key===c)return a});d?d++:(d={key:c,priority:a,count:1},this._overMats.push(d),this._overMats.sort(function(c,a){return a.priority-c.priority}));this.recalcOverMat()};
B.prototype.recalcOverMat=function(){if(this.hasOwnProperty("_overMats")){var c=this._overMats[0];if(this.overMat&&!c||!this.overMat&&c||this.overMat.key!==c.key)this.overMat=c?f.mat(c.key):!1,this.recalcSkinImages&&this.recalcSkinImages(),this.updateImg()}};B.prototype.removeOverMat=function(c){var a=this._overMats.find(function(a){if(a.key===c)return a});a.count--;1>a.count&&this._overMats.splice(this._overMats.indexOf(a),1);this.recalcOverMat()};B.prototype.setTile=function(c){this.tile!==c&&(this.tile&&
this.tile.units.splice(this.tile.units.indexOf(this),1),(this.tile=c)&&c.units.push(this))};var a,b,e,d=function(c){var d,n;d=e.tile.x-c.x;n=e.tile.y-c.y;if(b<d*d+n*n)return!0;if($b(e.tile,c,bd))return a(c)};B.prototype.getValue=function(){var c=f.mat1amount(this.imgId),a=f.mat2amount(this.imgId),c=this.mat1.price*c+this.mat2.price*a;this.burned&&(c=Math.floor(c/2));return c};B.prototype.getGrade=function(){return this.hasOwnProperty("grade")?this.grade:0};B.prototype.forEachVisibleTile=function(c,
k){c=16*c+8;b=c*c;a=k;e=this;this.tile.visibleTiles.some(d)};B.prototype.tileAligned=function(){return this.x===this.tile.x&&this.y===this.tile.y};B.prototype.say=function(c,a){this.visible&&ac(c,this.x+8,this.y+3*Math.random()+(this.uih||0),a)};B.prototype.update=function(){this.delay&&this.delay--;if(this.flySteps){if(!this.tile)return!0;if(!0===this.flySteps){if(this.y+=this.sy,this.sy+=.5,this.y>=this.tile.y-1)return this.flySteps=!1,"swapLayer"}else{this.flySteps--;this.x+=this.sx;this.y+=this.sy;
this.visible=x.getTile(this.x+8,this.y+8).visible;if(!this.flySteps){var c=x.getTile(this.x+2,this.y+2);c.door&&c.doorRef&&c.doorRef.itemDropped();if(this.type.onThrow&&this.type.onThrow.call(this,c)||this.mat1.onThrow&&this.mat1.onThrow.call(this,c)||this.mat2.onThrow&&this.mat2.onThrow.call(this,c))return!0;this.dropped(c)}return}}this.tile&&(this.visible=this.tile.explored)};B.prototype.replaceMat=function(c,a){this.mat1.key===c&&(this.mat1=f.mat(a));this.mat2.key===c&&(this.mat2=f.mat(a));this.updateImg()};
B.prototype.dropped=function(c){this.x=c.x;this.y=c.y;this.setTile(c);c.onMove();this.flySteps=!0;this.sy=-3};B.prototype.draw=function(){p.drawImage(this.img,(this.x+y)*h,(this.y+w)*h,16*h,16*h)}})();"use strict";var cb,A;(function(){var a=["#f00","#f40","#f80","#780","#080"];A=function(a,c){if(a){this.delay=5;this.sleep=u(2);this.walkPhase=0;this.setTeam(2);this.dir=u(4);cb=this.type=c;this.power=W("power",3);this.defence=Math.max(1,W("defence",2));this.lookDist=W("lookDist",5);var d=W("mat1","fur");
this.mat1=f.mat(d);d=W("mat2","flesh");this.mat2=f.mat(d);this.imgId=W("imgId",36);this.uih=W("uih",6);this.atackDelay=W("atackDelay",60);this.speed=W("speed",.25);this.setHP(W("hp",5));B.call(this,a);this.lockedTile=0===this.speed||c&&c.lockedTile;this.visible=a.visible;c&&c.onInit.call(this);c&&c.cantDropItems||this.cantDropItems||6!==u(10)||(d=0,c&&c.boss&&(d=8),wa(this,Z(void 0,void 0,d)));this.updateImg()}};A.walkPhases=[0,-1,-2,-1];A.prototype=new B;A.prototype.constructor=A;A.prototype.setTeam=
function(a){this.team=a;this.tile&&(this.tile.team=a)};A.prototype.onFire=function(a){this.type&&this.type.onFire.call(this);B.prototype.onFire.call(this,a);var c;(c=this.type&&this.type.hasOwnProperty("fireDamageMultiplier")?this.type.fireDamageMultiplier:1)&&this.damage(c,0,0,a)};A.prototype.serialize=function(){return this.type.name+"@"+this.hp+"@"+this.mat1.key+"@"+this.mat2.key};A.prototype.throwItemUnconditionally=function(a,c,b){a.flySteps=Math.max(1,Math.round(3*Math.max(Math.abs((c-this.x)/
16-.5),Math.abs((b-this.y)/16-.5))));a.sx=(c-this.x)/a.flySteps;a.sy=(b-this.y)/a.flySteps;this.removeItem&&this.removeItem(a);a.x=this.x;a.y=this.y;a.setTile(this.tile);ia(a)};A.prototype.throwItem=function(a,c,b){var d;try{d=x.getTile(c,b)}catch(Y){}d&&(c=d.x+8,b=d.y+8);c=(c-this.x)/16-.5;b=(b-this.y)/16-.5;var e=Math.max(Math.abs(c),Math.abs(b));c/=e;b/=e;for(var e=this.tile.i+.5+c,k=this.tile.j+.5+b,g=this.tile,f,h=0;h<this.lookDist;){try{f=x.tiles[Math.floor(e)][Math.floor(k)]}catch(Y){break}if(f.wall)break;
h++;g=f;if(f===d||f.wall||1===f.grass||f.door||f.flower||f.unit)break;e+=c;k+=b}h?(a.flySteps=3*h,a.sx=(g.x-this.tile.x)/a.flySteps,a.sy=(g.y-this.tile.y)/a.flySteps,!this.removeItem||this.hasItem&&!this.hasItem(a)?ea(a):this.removeItem(a),a.x=this.tile.x,a.y=this.tile.y,a.setTile(this.tile),ia(a)):this.drop(a);return!0};A.prototype.drop=function(a){!this.removeItem||this.hasItem&&!this.hasItem(a)?ea(a):this.removeItem(a);ia(a);a.dropped(this.tile)};A.prototype.setTile=function(a){this.tile!==a&&
(a&&(a.team=this.team,a.unit=this),this.tile&&(this.tile.team=0,this.tile.unit=void 0),B.prototype.setTile.call(this,a))};A.prototype.canPass=function(a){return a&&(!a.wall||a.team)&&!a.door&&(this.mad||a.team!==this.team)};A.prototype.tryMoveTo=function(a){if(a){if(a.team){if(this.mad||a.team!==this.team)return this.attackTile(a),!0}else if(!this.lockedTile&&this.canPass(a))return this.setTile(a),!0;this.targetTile=void 0;this.delay=10+u(14);this.dir=u(4)}};var b=function(a,c){for(var b=0,d=0;4>
d;d++)b+=Math.max(0,u(a+1)-u(c));return Math.max(0,Math.round(b/4))};A.prototype.attackTile=function(a){var c=this;this.delay=this.atackDelay;var d=a.x-this.x,e=a.y-this.y,f=Math.sqrt(d*d+e*e);0<f&&(f/=3,d/=f,e/=f);this.x+=Math.round(d);this.y+=Math.round(e);var g=a.unit;if(0<g.hp){var h=b(this.power,g.defence);vb(this,"invisible")&&(h+=this.power);g.damage(h,d,e,this);0<h&&(Nc(this,"invisible"),this.type&&this.type.onAttack&&this.type.onAttack.call(this,g,h),this.equiped&&this.equiped.some(function(a){a.canEquipByLevel()||
(c.delay+=160,c.say(m("Too heavy"),"#f20"));a.onAttack.call(a,g,h)}))}};var e;A.prototype.lookEnemyHere=function(a){if(e.isEnemyHere(a))return e.targetTile=a,!0};A.prototype.isEnemyHere=function(a){return a.team&&!a.unit.invisible&&(e.mad||a.team!==e.team)};A.prototype.shootEnemyHere=function(a){if(e.isEnemyHere(a)){var c=bc(e.bullet||e.type.bullet,a.unit,e.x,e.y,e.type.power);e.type.onShoot&&e.type.onShoot.call(e,c);e.delay=e.atackDelay;e.lockedTile||e.reflect===a.x<e.x||(e.reflect=a.x<e.x,e.updateImg());
return!0}};A.prototype.onLogic=function(){e=this;if(this.type&&(this.type.onLogic&&this.type.onLogic.call(this)||!this.sleep&&this.type.bullet&&(this.forEachVisibleTile(this.type.shootDist,this.shootEnemyHere),this.delay)))return;this.forEachVisibleTile(this.sleep&&.93>Math.random()?2:this.lookDist,this.lookEnemyHere);if(this.targetTile===this.tile||Ka())this.targetTile=void 0;if(this.sleep&&(this.targetTile||A.wakeupAll))this.sleep=!1,this.delay=120,this.say("!!!","#f80"),--this.y;else{if(this.targetTile){var a=
this.targetTile.x-this.x,c=this.targetTile.y-this.y;Math.abs(a)>Math.abs(c)?0<a?this.canPass(this.tile.right)?this.dir=1:this.dir=0<c?2:0:this.canPass(this.tile.left)?this.dir=3:this.dir=0<c?2:0:0<c?this.canPass(this.tile.down)?this.dir=2:this.dir=0<a?1:3:this.canPass(this.tile.up)?this.dir=0:this.dir=0<a?1:3}if(this.sleep)this.say(.5<Math.random()?"z":"Z","#59c"),this.delay=35+u(30);else switch(this.dir){case 0:this.tryMoveTo(this.tile.up);break;case 1:!e.lockedTile&&this.reflect&&(this.reflect=
!1,this.updateImg());this.tryMoveTo(this.tile.right);break;case 2:this.tryMoveTo(this.tile.down);break;case 3:e.lockedTile||this.reflect||(this.reflect=!0,this.updateImg()),this.tryMoveTo(this.tile.left)}}};A.prototype.onDie=function(a){this.visible?(this.delay=80,6===this.mat1.t||6===this.mat2.t?Oc(this):Wb(this.x,this.y)):this.delay=0;this.mat1.onDie&&this.mat1.onDie.call(this);this.mat2.onDie&&this.mat2.onDie.call(this);this.type&&(1!==this.team&&g.addXp(this.type.xp),this.type.onDie.call(this),
this.type.boss&&ra(m(this.type.name)+" "+m("defeated!"),"#f80"),1===this.tile.distance&&(ja=void 0,x.clearDistances()));this.fire&&this.fire.unitDead();this.tile.wall||xc(this);this.setTile(null)};A.prototype.setHP=function(a){this.maxHp=this.hp=a};A.prototype.damage=function(a,c,b,e){if(0>=a)this.say(m("miss"),"#555");else if(void 0===c&&(c=0),void 0===b&&(b=0),!(0>=this.hp)){this.type&&this.type.onDamage.call(this,a,c,b,e);this.sleep&&(this.targetTile=this.tile.up);this.hp-=a;0>=this.hp&&(this.onDie(),
this.hp=0);this.say("-"+a,"#e00");this.walkPhase=0;a=Math.max(2,Math.min(5,Math.round(a/3)));var d=Math.sqrt(c*c+b*b);0<d&&(d/=a,c/=d,b/=d);0!==this.speed&&(this.x+=Math.round(c),this.y+=Math.round(b));if(this.visible){for(;0<a;)d=M(this.x+c+8,this.y+b+8,Ia,Sb),d.xs=c-2+4*Math.random(),d.ys=b-2+4*Math.random(),a--;if(0!==c||0!==b)Math.abs(c)>Math.abs(b)?(a=Math.max(e&&e.uih?e.uih:0,this.uih),a=0>c?M(this.x+16,this.y+a,Cb,wb):M(this.x-16,this.y+a,Cb,wb),a.phase=7):(a=0>b?M(this.x,this.y+8,Cb,wb):M(this.x,
this.y-8+this.uih,Cb,wb),a.phase=8),a.xs=c,a.ys=b}}};A.prototype.removeBadEffects=function(){this.fire&&(this.fire.pow=0);Pc(this)};A.prototype.update=function(){if(!this.tile){if(this.delay){this.delay--;this.visible=!(this.delay&8);return}return!0}if(0!==this.speed){var a=this.tile,c=!1;a.x<this.x-this.speed?(this.x-=this.speed,this.walkPhase+=La,c=!0):a.x>this.x+this.speed?(this.x+=this.speed,this.walkPhase+=La,c=!0):a.x!==this.x&&(this.x=a.x,this.walkPhase+=La,c=!0);a.y<this.y-this.speed?(this.y-=
this.speed,this.walkPhase+=La,c=!0):a.y>this.y+this.speed?(this.y+=this.speed,this.walkPhase+=La,c=!0):a.y!==this.y&&(this.y=a.y,this.walkPhase+=La,c=!0)}if(!c)if(this.delay)this.delay--,this.walkPhase=0;else if(this.onLogic())return!0;if(this.isFly||3<this.walkPhase)this.walkPhase=0;this.visible=this.lockedTile?this.tile.explored:x.getTile(this.x+8,this.y+8).visible};A.prototype.drawUI=function(){if(this.hp<this.maxHp&&0<this.hp){var b=Math.min(16,3+this.maxHp/2)*h,c=this.hp/this.maxHp,e=(this.x+
y+8)*h-b/2,n=(this.y+w+this.uih)*h;p.fillStyle=a[Math.round(3.9*c)];p.fillRect(e,n,b*c,h);p.fillStyle="#000";p.fillRect(e+b*c,n,b*(1-c),h)}};A.prototype.draw=function(){1!==this.team&&cc++;this.img&&(p.drawImage(this.img,(this.x+y)*h,(this.y+w+A.walkPhases[this.walkPhase])*h,16*h,16*h),this.drawUI())}})();"use strict";var g,Qc,zb,Ka,Gc,Fb;(function(){function a(){g.transform&&g.transform.hasOwnProperty("abilities")&&g.transform.abilities.some(function(a){Fb[a].usedOnLevelCount=0})}var b,e,d,c,k,n,
F,S,T,ca,q,Y;window.addEventListener("keydown",function(a){ja=void 0;switch(a.keyCode){case 80:n.pickupItem(n.tile);break;case 27:case 73:r.toggle();break;case 37:case 65:V(a);d=!0;x.clearTarget();break;case 39:case 68:V(a);c=!0;x.clearTarget();break;case 38:case 87:V(a);b=!0;x.clearTarget();break;case 40:case 83:V(a);e=!0;x.clearTarget();break;case 49:r.useSlot1();break;case 50:r.useSlot2()}});window.addEventListener("keyup",function(a){switch(a.keyCode){case 37:case 65:d=!1;break;case 39:case 68:c=
!1;break;case 38:case 87:b=!1;break;case 40:case 83:e=!1}});window.addEventListener("blur",function(){e=b=c=d=!1});var U=function(a){a.visible=!1},l=function(a){a.updateFog()},t=function(){Ta.some(U);Ta.some(l);Ta.length=0},C=function(a,c){a.forEachVisibleTile(c||a.lookDist,zc);zc(a.tile)},v=[],N=[];g=function(c){1===K&&g.surprise("firstLevel");g.noGameover=!1;g.mindVision=0;this.cantDropItems=!0;A.call(this,c);g.instance=this;n=this;this.setTeam(1);this.wpb=this.wph=this.wpl=0;this.recalcSkinImages();
N=(N=H("equiped"))?N.split("#").map(function(a){return Gb(a)}).filter(function(a){return a}):[];Fb||ib();a();v=(v=H("inventory"))?v.split("#").map(function(a){return Gb(a)}).filter(function(a){return a}).concat(N):[].concat(N);(c=H("friends"))&&c.split("#").some(function(a){var c=I.shift();if(c){a=a.split("@");var b=Wa(c,a[0]);b.hp=parseInt(a[1]);b.mat1=f.mat(a[2]);b.mat2=f.mat(a[3]);b.updateImg();c.team=1;b.team=1;b.sleep=!1}});this.inventory=v;this.equiped=N;t();C(this);Ta.some(l);this.recalcStats();
this.hp=H("hp",this.maxHp);Hb.heroPic=g.transform&&g.transform.heroPic?g.transform.heroPic:"data/hero.png";this.uih=g.transform&&g.transform.uih?g.transform.uih:-7;g.transform&&g.transform.lookDist&&(xa=g.transform.lookDist);r.refreshActions()};var ib=function(){Fb={ratsInvisibility:{name:"invisibility",imgId:36,mat1:f.mat("invisibility"),mat2:f.mat("invisibility"),isEnabled:function(){return 0===this.usedOnLevelCount},onClick:function(){Ma(g.instance.tile,40)}}}};Gc=function(a){z("hp",a.hp);z("currentLevel",
K);var c=a.equiped.map(function(a){return a.serialize()}).join("#"),b=a.inventory.filter(function(c){return!a.isEquiped(c)}).map(function(a){return a.serialize()}).join("#"),e=[];aa.filter(function(a){4>e.length&&1===a.team&&a.unit!==g.instance&&a.unit.speed&&!Ib(a.unit).some(function(a){return"paralized"===a.type.name})&&e.push(a.unit)});e=e.map(function(a){return a.serialize()}).join("#");z("equiped",c);z("friends",e);z("inventory",b);z("playersLevel",oa);z("xp",Pa);z("xpToNextLevel",fb);z("playersGold",
ha);z("playersAttack",gb);z("playersDefence",sb);z("playersMaxHp",Qa);z("playersLookDist",xa);z("playersCapacity",Ra);z("spearThroughting",Sa);z("transform",g.transform);z("playersAttempt",1);fa=1;z("attemptCommited",!1);db=!1;eb()};Ka=function(){return 0>=n.hp&&!g.noGameover};g.surprise=function(a){if(a){var c=H("surprises");c||(c={},z("surprises",c));if(c[a])return;c[a]=1}ka(function(){k=120+Math.round(190*Math.random())},160)};zb=function(){z("xp",0);z("playersLevel",1);z("xpToNextLevel",10);z("equiped",
"");z("friends","");z("inventory","Heal Potion@0@garnet@glass");z("playerSeed",19263520*Math.random());z("currentLevel",0);z("playersGold",0);z("playersAttack",1);z("playersDefence",1);z("hp",25);z("playersMaxHp",25);z("playersLookDist",4);z("playersCapacity",5);z("spearThroughting",0);z("playersAttempt",1);Zb("transform");Zb("surprises");eb()};Qc=function(){Ab.newGame();zb();hb=!0};g.addXp=function(a){0<n.hp&&(Pa+=a,Pa>=fb&&(Pa=0,oa++,n.say(m("Level reached!").replace("%",oa)),n.recalcStats(),n.hp=
Math.min(n.maxHp,n.hp+10),fb=10*oa,O(new Na(n)),ka(Rc,700)))};g.prototype=new A;g.prototype.constructor=g;var D=function(a,c){return a.z-c.z};g.prototype.recalcSkinImages=function(){var a=this.skinMat||f.mat("flesh");this.legsPic=f.img(11,this.overMat||f.mat("cotton"),this.overMat||a);this.bodyPic=f.img(12,this.overMat||f.mat("cotton"),this.overMat||a);this.headPicSurprise=f.img(130,this.overMat||f.mat("fur"),this.overMat||a);this.headPic=f.img(13,this.overMat||f.mat("fur"),this.overMat||a);this.legsPicR=
f.img("11r",this.overMat||f.mat("cotton"),this.overMat||a);this.bodyPicR=f.img("12r",this.overMat||f.mat("cotton"),this.overMat||a);this.headPicR=f.img("13r",this.overMat||f.mat("fur"),this.overMat||a);this.headPicRSurprise=f.img("130r",this.overMat||f.mat("fur"),this.overMat||a);this.mat1=this.overMat||f.mat("fur");this.mat2=this.overMat||a};g.prototype.recalcStatsSub=function(a){a.type.recalcStats(this,a);"armor"===a.type.equipType&&a.getLevel()>oa&&(this.speed/=2);if(a.type.onImgId){var c={i:f.img(a.type.onImgId,
this.overMat||a.mat1,this.overMat||a.mat2),x:a.type.onx,y:a.type.ony,z:a.type.onz},b={i:f.img(a.type.onImgId+"r",this.overMat||a.mat1,this.overMat||a.mat2),x:-a.type.onx,y:a.type.ony,z:a.type.onz};switch(a.type.equipType){case "sword":case "armor":case "shield":case "ring":F.push(c);ca.push(b);break;case "helmet":case "amulet":T.push(c);Y.push(b);break;case "pants":case "boots":S.push(c),q.push(b)}}};var E=function(a){a.type.recalcStats&&a.type.recalcStats.call(a,this)};g.prototype.recalcStats=function(){this.lockedTile=
!1;this.atackDelay=30;this.power=gb;this.defence=sb;this.maxHp=Qa;this.speed=1;this.lookDist=xa+dc;this.lookDistSelfOnly=xa;this.noParalize=this.noToxic=!1;F=[];S=[];T=[];ca=[];q=[];Y=[];this.equiped.some(this.recalcStatsSub.bind(this));F.sort(D);S.sort(D);T.sort(D);ca.sort(D);q.sort(D);Y.sort(D);Ib(this).some(E.bind(this));var a=this.reflect;this.setReflection(!a);this.setReflection(a)};g.prototype.onLogic=function(){ja===this.tile&&(ja=void 0);1===this.tile.distance&&(this.pickupItem(this.tile),
x.clearDistances());this.tile.distance&&(1===this.tile.distance-this.tile.up.distance?ja=this.tile.up:1===this.tile.distance-this.tile.down.distance?ja=this.tile.down:1===this.tile.distance-this.tile.left.distance?ja=this.tile.left:1===this.tile.distance-this.tile.right.distance&&(ja=this.tile.right));if(!b&&this.tile.up!==ja||!this.tryMoveTo(this.tile.up))if(!e&&this.tile.down!==ja||!this.tryMoveTo(this.tile.down))if(d||this.tile.left===ja)this.reflectHead=!1,this.setReflection(!0),this.tryMoveTo(this.tile.left);
else if(c||this.tile.right===ja)this.reflectHead=!1,this.setReflection(!1),this.tryMoveTo(this.tile.right);this.tileAligned()&&(this.walkPhase=0);xb&&500<u(1E3)&&this.tileAligned()&&(this.reflectHead=!this.reflectHead);t();C(this);if(0<g.mindVision)for(var a=x.units._listNext;a!==x.units;)0<a.hp&&a.tile&&C(a,1),a=a._listNext;Ta.some(l)};g.prototype.setReflection=function(a){this.reflect!==a&&(this.reflect=a,g.transform&&g.transform.imgId?(this.imgId=g.transform.imgId,this.mat1=f.mat(g.transform.mat1),
this.mat2=f.mat(g.transform.mat2),this.updateImg()):this.img=!1)};g.prototype.exploreTilesOnTeleport=function(a){t();C(this);Ta.some(l)};var ba=function(){db||(z("attemptCommited",!0),eb(),db=!0)};g.prototype.tryMoveTo=function(a){if(a.team&&a.team!==this.team)ba(),this.attackTile(a);else if(!this.lockedTile&&J(a)){ba();a.onMove();if(a.unit){var c=a.unit,b=this.tile;c.setTile(void 0);this.setTile(a);c.setTile(b)}else this.setTile(a);return!0}return!1};g.prototype.onDie=function(){this.visible=!1;
var a=new B(this.tile);a.imgId=37;a.mat1=f.wallMat();a.mat2=this.tile.mat1;a.updateImg();a.update=function(){this.tile.door=!0};this.tile.door=!0;Xa(a);this.rip=a;this.inventory.some(function(a){if(a.type.onDie)return a.type.onDie.call(a)})||(ra(m("You Die!"),"#a00"),db&&fa>=Ha&&ra(m("GAME_OVER"),"#a00"));A.prototype.onDie.call(this);r.close(!0);r.refreshActions()};g.prototype.onFire=function(){A.prototype.onFire.call(this);this.mat1=f.mat("flesh");this.mat2=f.mat("flesh")};g.prototype.update=function(){k&&
k--;if(this.flySteps&&(this.y+=this.sy,this.x+=this.sx,!0===this.flySteps?(this.sy+=.125,1.5<=this.sy&&(this.flySteps=!1)):(this.flySteps--,0>=this.flySteps&&(this.flySteps=!0,this.sy=-1.5)),this.flySteps))return;if(!this.tile)return!0;0<g.mindVision&&g.mindVision--;if(A.prototype.update.call(this))return!0;this.delay&&Math.random()<.6*(this.speed-1)&&this.delay--;if(!this.tileAligned()){var a=Math.max(pa/h/2-48,16),c=Math.max(ya/h/2-48,16),b=this.x-jb(ya/2)+8,e=this.y-kb(pa/2)+8;b>c?y+=Math.min(3,
c-b):b<-c&&(y+=Math.min(3,-c-b));e>a?w+=Math.min(3,a-e):e<-a&&(w+=Math.min(3,-a-e))}Tb&&(this.wph=this.wpb,this.wpb=this.wpl,this.wpl=A.walkPhases[this.walkPhase]);ec&&r.refreshActions()};g.prototype.pickupItem=function(a,c){if(a){if(a.units){var b=a.enumItems();b.sort(function(a,c){a=a.hasOwnProperty("slot")?a.slot:1E4;c=c.hasOwnProperty("slot")?c.slot:1E4;return c-a});if(b.length)a=b.pop();else return}a.type&&a.type.onPickUp&&a.type.onPickUp.call(a)||(a.tile&&ea(a),c||this.hasEmptySlot(a)?(a.setTile(null),
a.slot=this.getEmptySlot(a),this.inventory.push(a),this.recalcStats(),Ja()||this.say(a.getName(),"#555")):(ia(a),a.dropped(this.tile),Ja()||this.say(m("no place for")+" "+a.getName(),"#555")))}};g.prototype.hasItem=function(a){return 0<=v.indexOf(a)};g.prototype.hasEmptySlot=function(a){return a&&a.type.itsMoneyNoNeedSlot&&g.canCollectMoney()?!0:void 0!==this.getEmptySlot(a)};g.prototype.getEmptySlot=function(a){var c,b,e=g.getCapacity();for(c=0;c<e;c++)if((b=this.getItemAtSlot(c))&&b.isSckableWith(a))return c;
for(c=0;c<e;c++)if(b=this.getItemAtSlot(c),!b)return c};g.prototype.getEquipedOfType=function(a){var c=[];this.equiped.some(function(b){0===a.indexOf(b.type.equipType)&&c.push(b)});return c};g.prototype.getItemById=function(a){var c;v.some(function(b){if(b.type.id===a)return c=b,!0});return c};g.prototype.consumeItem=function(a){this.hasItem(a)?this.removeItem(a):a.destroy();r.refreshActions()};g.prototype.removeItem=function(a){this.isEquiped(a)&&this.unequip(a,!0);this.inventory.splice(this.inventory.indexOf(a),
1)};g.prototype.addSkinMat=function(a,c){this.hasOwnProperty("_skinMats")||(this._skinMats=[]);"undefined"===typeof c&&(c=0);var b=this._skinMats.find(function(c){if(c.key===a)return c});b?b.count++:(b={key:a,priority:c,count:1},this._skinMats.push(b),this._skinMats.sort(function(a,c){return c.priority-a.priority}));this.recalcSkinMat()};g.prototype.recalcSkinMat=function(){if(this.hasOwnProperty("_skinMats")){var a=this._skinMats[0];if(this.skinMat&&!a||!this.skinMat&&a||this.skinMat.key!==a.key)this.skinMat=
a?f.mat(a.key):!1,this.recalcSkinImages(),this.updateImg()}};g.prototype.removeSkinMat=function(a){var c=this._skinMats.find(function(c){if(c.key===a)return c});c.count--;1>c.count&&this._skinMats.splice(this._skinMats.indexOf(c),1);this.recalcSkinMat()};g.prototype.equip=function(a){this.hasItem(a)||this.pickupItem(a,!0);a.slot=void 0;var c=this.getEquipedOfType(a.type.equipType);if("ring"===a.type.equipType){var b=4;g.transform&&g.transform.hasOwnProperty("ringsLimit")&&(b=g.transform.ringsLimit);
c.length>=b&&this.unequip(c.pop())}else 0<c.length&&this.unequip(c.pop());this.equiped.push(a);a.mat1.onEquip&&a.mat1.onEquip.call(this,a);a.mat2.onEquip&&a.mat2.onEquip.call(this,a);this.recalcStats()};g.prototype.unequip=function(a,c){var b=this.equiped.indexOf(a);if(0>b)throw console.dir(a),Error("item is not equiped");this.equiped.splice(b,1);c||(this.hasEmptySlot(a)?a.slot=this.getEmptySlot(a):this.drop(a));this.recalcStats()};g.prototype.isEquiped=function(a){return 0<=this.equiped.indexOf(a)};
g.prototype.getItemsCountAtSlot=function(a){var c=0;this.inventory.some(function(b){b.slot===a&&c++});return c};var Oa,Sc,fc=function(a){if(a.slot===Sc)return Oa=a,!0};g.prototype.getItemAtSlot=function(a){Oa=void 0;Sc=a;this.inventory.some(fc);return Oa};g.prototype.attackEnemy=function(a){a.tile&&(ja=a.tile,a.tile.distance=1)};var Ya,na,jd=function(a){p.drawImage(a.i,(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)},kd=function(a){p.drawImage(a.i,(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)},ld=function(a){p.drawImage(a.i,
(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)},md=function(a){p.drawImage(a.i,(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)},nd=function(a){p.drawImage(a.i,(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)},G=function(a){p.drawImage(a.i,(Ya+a.x)*h,(na+a.y)*h,16*h,16*h)};g.prototype.draw=function(){this.img?A.prototype.draw.call(this):(Ya=this.x+y,this.reflect?(p.drawImage(this.legsPicR,(this.x+y)*h,(this.y+w+this.wpl)*h,16*h,16*h),na=this.y+w+this.wpl,q.some(jd),p.drawImage(this.bodyPicR,(this.x+y)*h,(this.y+w+this.wpb-4)*h,16*h,16*h),na=
this.y+w+this.wpb-4,ca.some(kd)):(p.drawImage(this.legsPic,(this.x+y)*h,(this.y+w+this.wpl)*h,16*h,16*h),na=this.y+w+this.wpl,S.some(ld),p.drawImage(this.bodyPic,(this.x+y)*h,(this.y+w+this.wpb-4)*h,16*h,16*h),na=this.y+w+this.wpb-4,F.some(md)),this.reflectHead^this.reflect?(p.drawImage(k?this.headPicRSurprise:this.headPicR,(this.x+y)*h,(this.y+w+this.wph-8)*h,16*h,16*h),na=this.y+w+this.wph-8,Y.some(G)):(p.drawImage(k?this.headPicSurprise:this.headPic,(this.x+y)*h,(this.y+w+this.wph-8)*h,16*h,16*
h),na=this.y+w+this.wph-8,T.some(nd)),this.drawUI())};g.setTransform=function(c){if(c){c.disableSlots&&(c.disableSlots.some(function(a){var b=g.instance.getEquipedOfType(a)[0];b&&g.instance.unequip(b);c["disable_"+a]=!0}),delete c.disableSlots);if(c.hasOwnProperty("ringsLimit"))for(var b=g.instance.getEquipedOfType("ring"),e=c.ringsLimit;4>e;e++)c["disable_ring"+e]=!0,b.length>c.ringsLimit&&g.instance.unequip(b.pop());if(c.hasOwnProperty("capacityLimit")){b=c.capacityLimit;for(e=v.length-1;0<=e;e--)g.instance.isEquiped(v[e])&&
b++;for(e=v.length-1;e>=b;e--)g.instance.isEquiped(v[e])?b--:g.instance.drop(v[e])}c.cantCareGold&&0<ha&&(e=Z(130>ha?"moneySmall":"moneyBig"),e.val=ha,ia(e),e.dropped(g.instance.tile),ha=0)}g.transform=c;e=g.instance;b=e.tile;e.setTile(null);b=new g(b);b.x=e.x;b.y=e.y;e.destroy();Xa(b);b.inventory=e.inventory;b.equiped=e.equiped;v=e.inventory;N=e.equiped;b.recalcStats();a()};g.canCollectMoney=function(a){return!g.transform||!g.transform.cantCareGold};g.getCapacity=function(a){return g.transform&&
g.transform.hasOwnProperty("capacityLimit")?Math.min(Ra,g.transform.capacityLimit):Ra};g.isSlotDisabled=function(a){if(g.transform)return g.transform["disable_"+a]}})();"use strict";var sa;(function(){sa=function(a){this.imgId=31;95<u(100)?this.mat1=f.mat("iron"):this.mat1=f.mat("wood");this.mat2=f.mat("iron");B.call(this,a);a.setType(26);this.setState(!0);a.doorRef=this};sa.prototype=new B;sa.prototype.constructor=sa;sa.prototype.onFire=function(a){this.burned||(B.prototype.onFire.call(this,a),a&&
R(this.tile,void 0,4),this.delay=100,this.burned=!0)};sa.prototype.onExplode=function(){this.onFire();this.setState(!1)};sa.prototype.setState=function(a){this.tile.door=a;this.tile.down.wall||(this.tile.down.shadow=a)};sa.prototype.itemDropped=function(){this.setState(!1);this.delay=35;this.img=f.img(this.imgId+1,this.mat1,this.mat2)};sa.prototype.update=function(){B.prototype.update.call(this);if(this.burned&&!this.delay)return this.setState(!1),delete this.tile.doorRef,!0;this.delay||(1===this.tile.units.length?
this.needDelay?(this.delay=20,this.needDelay=!1):(this.setState(!0),this.img=f.img(this.imgId,this.mat1,this.mat2)):(this.needDelay||(this.needDelay=!0,g.surprise("doorOpen"),this.setState(!1)),this.img=f.img(this.imgId+1,this.mat1,this.mat2)))}})();"use strict";var Aa;(function(){Aa=function(a,e){this.i=a;this.j=e;this.x=16*a;this.y=16*e;this.right=this.left=this.down=this.up=void 0};Aa.prototype.reset=function(){delete this.visibleTiles;this.team=0;this.fog=this.thinFog=!1;this.units=[];this.image=
x.wallType;this.mat2=this.mat1=x.wallMaterial;delete this.visible;delete this.explored;delete this.water;delete this.distance;delete this.unit;delete this.grass;delete this.door;delete this.flower;delete this.doorRef;delete this.gas;delete this.shadow;delete this.itemsToDrop;this.wall=!0};var a=function(a){return a.constructor===P};Aa.prototype.enumItems=function(){return this.units.filter(a)};Aa.prototype.updateFog=function(){if(this.explored){var a;this.visible?(a=0,this.up?(this.up.visible||(a|=
2),this.up.left&&this.up.left.visible||(a|=1),this.up.right&&this.up.right.visible||(a|=4)):a|=7,this.right&&this.right.visible||(a|=8),this.down?(this.down.visible||(a|=32),this.down.left&&this.down.left.visible||(a|=64),this.down.right&&this.down.right.visible||(a|=16)):a|=112,this.left&&this.left.visible||(a|=128),this.fog=0!==a?a:!1):this.fog=0;a=0;this.up?(this.up.explored||(a|=2),this.up.left&&this.up.left.explored||(a|=1),this.up.right&&this.up.right.explored||(a|=4)):a|=7;this.right&&this.right.explored||
(a|=8);this.down?(this.down.explored||(a|=32),this.down.left&&this.down.left.explored||(a|=64),this.down.right&&this.down.right.explored||(a|=16)):a|=112;this.left&&this.left.explored||(a|=128);this.thinFog=0!==a?a:!1}else this.fog=!1,this.thinFog=0};Aa.prototype.onMove=function(){1==this.grass&&(this.grass=2,xc(this))};Aa.prototype.neighborPassesCount=function(){var a=0;J(this.up)&&a++;J(this.down)&&a++;J(this.left)&&a++;J(this.right)&&a++;return a};Aa.prototype.goodForRoom=function(){return this.up&&
(J(this.up.left)||J(this.up.right))||this.down&&(J(this.down.left)||J(this.down.right))?!1:!0};Aa.prototype.setType=function(a){this.image=a;this.wall=!1}})();"use strict";var x,jb,kb,la=0,Tb,La,gc,ec,hc,Jb,xb,ic,ka,ja,lb,dc=0,y=0,w=0,Za,mb,Kb,h=H("scale",5),Lb=h,Ha=5,K,Rb,Pa,oa,db,fa,fb,$b,ha,gb,sb,Qa,xa,Ra,Sa,jc,I,yb=function(a){a&&a.up&&a.down&&a.left&&a.right&&nb(a)},nb=function(a){a.setType(x.floorType);a.mat1=x.floorMaterial;a.mat2=x.floorMaterial};yc();var hb,Ta=[],Ba,Xa,O,ia,aa;(function(){var a=
{};[[136,135,44,[98,97,22]],[119,118,34,[98,97,22]],[109,108,28,[98,97,22]],[147,146,52,[98,97,22]],[76,136,44,[34,100,17]],[116,101,78,[92,73,53]],[123,108,84,[92,73,53]],[108,93,70,[84,66,46]],[91,156,56,[44,116,25]],[62,120,32,[28,88,13]],[134,118,94,[92,73,53]],[148,109,41,[94,63,19]],[120,82,28,[94,63,19]],[185,143,69,[94,63,19]]].some(function(c){a[(c[0]&248)+256*(c[1]&248)+65536*(c[2]&248)]=c[3]});var b=function(c,b,e,d){var k,n,f,g=Math.round(16*h);k=Math.round((b+1)*h);for(f=Math.round(b*
h);f<k;f++)for(b=Math.round((c+e)*h)+f*g,n=Math.round(c*h)+f*g;n<b;n++){var v=d,ba=4*n,F=(v[ba]&248)+256*(v[ba+1]&248)+65536*(v[ba+2]&248);a.hasOwnProperty(F)&&(F=a[F],v[ba]=F[0],v[ba+1]=F[1],v[ba+2]=F[2])}},e=[];ka=function(a,c,b,d){e.push({f:a,t:c/1E3*60,p1:b,p2:d})};var d=function(){0<e.length&&(e=e.filter(function(a){a.t--;if(0<a.t)return!0;a.f(a.p1,a.p2)}))},c=[],k=0;jc=function(a){k=Math.max(k,a)};var n,F,S,T,ca={},q={},Y={},U=function(a,c){return a.distance-c.distance};$b=function(a,c,b){var e=
a.i;a=a.j;var d,k,n,f,g,h,v;g=Math.max(Math.abs(e-c.i),Math.abs(a-c.j));d=e+.5;k=a+.5;n=(c.i-d+.1)/g;f=(c.j-k+.1)/g;v=g;for(h=!0;1<v;){d+=n;k+=f;if(!b(x.tiles[Math.floor(d)][Math.floor(k)])){h=!1;break}v--}if(h)return!0;d=e+.5;k=a+.5;n=(c.i-d+.9)/g;f=(c.j-k+.1)/g;v=g;for(h=!0;1<v;){d+=n;k+=f;if(!b(x.tiles[Math.floor(d)][Math.floor(k)])){h=!1;break}v--}if(h)return!0;d=e+.5;k=a+.5;n=(c.i-d+.9)/g;f=(c.j-k+.9)/g;v=g;for(h=!0;1<v;){d+=n;k+=f;if(!b(x.tiles[Math.floor(d)][Math.floor(k)])){h=!1;break}v--}if(h)return!0;
d=e+.5;k=a+.5;n=(c.i-d+.1)/g;f=(c.j-k+.9)/g;v=g;for(h=!0;1<v;){d+=n;k+=f;if(!b(x.tiles[Math.floor(d)][Math.floor(k)])){h=!1;break}v--}if(h)return!0;d=e+.5;k=a+.5;n=(c.i-d+.5)/g;f=(c.j-k+.5)/g;v=g;for(h=!0;1<v;){d+=n;k+=f;if(!b(x.tiles[Math.floor(d)][Math.floor(k)])){h=!1;break}v--}if(h)return!0};var l;lb=function(){l=aa.filter(function(a){return!a.wall||a.left&&(!a.left.wall||a.left.up&&!a.left.up.wall||a.left.down&&!a.left.down.wall)||a.right&&(!a.right.wall||a.right.up&&!a.right.up.wall||a.right.down&&
!a.right.down.wall)||a.up&&!a.up.wall||a.down&&!a.down.wall});l.some(r);t=!0;N()};var r=function(a){var c,b,e;a.visibleTiles=[];l.some(function(d){b=a.i-d.i;e=a.j-d.j;c=b*b+e*e;110.25>=c&&a!==d&&$b(a,d,cd)&&(a.visibleTiles.push(d),d.distance=c)});a.shadow=a.up&&a.up.wall&&!a.wall;a.visibleTiles.sort(U)};O=function(a){vc(ca,a)};ia=function(a){vc(ca,a)};Xa=function(a){rb(q,a)};Ba=function(a){rb(Y,a)};var t=!1,v=function(a){a.distance=void 0},N=function(){t&&(aa.some(v),t=!1)},ib=function(a,c){N();t=
!0;a.distance=1;for(var b=[a],e=[],d;0<b.length;){d=b.shift();var k=d.distance+1;d.left&&J(d.left,c)&&!d.left.distance&&(b.push(d.left),e.push(d.left),d.left.distance=k);d.right&&J(d.right,c)&&!d.right.distance&&(b.push(d.right),e.push(d.right),d.right.distance=k);d.up&&J(d.up,c)&&!d.up.distance&&(b.push(d.up),e.push(d.up),d.up.distance=k);d.down&&J(d.down,c)&&!d.down.distance&&(b.push(d.down),e.push(d.down),d.down.distance=k)}return e},C=function(a,b,e){if(a){var d=Math.max(1,a.i-u(b)-1),k=Math.min(Za-
2,a.i+u(b)),n=Math.max(1,a.j-u(b)-1);for(b=Math.min(mb-2,a.j+u(b));d<=k;d++)for(var g=n;g<=b;g++)a=c[d][g],nb(a),a.setType(e||x.floorType)}};jb=function(a){return a/h-y};kb=function(a){return a/h-w};var z=function(a,c,b){if(b&&b.team&&1!==b.team)return b=b.unit,a>=b.x&&a<=b.x+16&&c>=b.y&&c<=b.y+16};x={units:q,clearTarget:function(){N()},getLevelName:function(){return 0===K?m("firstLevelName"):m("Floor")+": "+K},onClick:function(a,c){try{var b=this.getTile(a,c)}catch(fc){}b&&(z(a,c,b.up)?b=b.up:z(a,
c,b.down)?b=b.down:z(a,c,b.left)?b=b.left:z(a,c,b.right)&&(b=b.right),b.explored&&ib(b,!0))},getTile:function(a,b){return c[Math.floor(a/16)][Math.floor(b/16)]},killAllEnemy:function(){for(var a=q._listNext;a!==q;)1!==a.team&&0<a.hp&&a.damage(a.hp),a=a._listNext},init:function(a,b){if(Za!==a||mb!==b){aa=[];c.length=0;this.tiles=c;for(var e=0;e<a;e++){var d=[];c[e]=d;for(var k=0;k<b;k++)d[k]=new Aa(e,k)}for(e=0;e<a;e++)for(d=c[e],k=0;k<b;k++){var n=d[k];aa.push(n);0<e&&(n.left=c[e-1][k]);e<a-1&&(n.right=
c[e+1][k]);0<k&&(n.up=d[k-1]);k<b-1&&(n.down=d[k+1])}Za=a;mb=b}this.generateDungeon(K)},generateDungeonSub:function(a,b){A.wakeupAll=!1;var e=45>=a&&a&&0===a%5;Xb(173*a+Rb+b);this.wallType=f.imgRandomId(2);this.floorType=f.imgRandomId(1);this.wallMaterial=f.wallMat();this.floorMaterial=f.matRandom(0,1E4,1);this.waterMat1=f.matRandom(0,1E6,4);this.waterMat2=f.matRandom(0,1E6,4);this.grassMat1=f.mat("grass");this.grassMat2=f.mat("grass");Kb=u(110);aa.map(function(a){a.reset()});Tc();Uc();qb(ca);qb(q);
qb(Y);var d=c[1+u(Za-2)][1+u(mb-2)],k=d,h,v,N,Oa;I=[];var l;if(0===a){n=0;F=384;S=0;T=256;d=new $a(c[0][0],f.backgroundImg);Ba(d);d=new $a(c[0][0],f.treeImg);d.x=222;d.y=181;ia(d);Oa=N=v=h=1E4;for(var p=";;;;;      #;     ###;    ###### # ######;    ###### # ######;    ###########  ##;    ###############;    ##############;     ######;     #   #;         #".split(";"),d=0;d<c.length;d++)for(l=0;l<c[0].length;l++)if(p[l]&&"#"===p[l][d]){var r=c[d][l];nb(r);I.push(r)}aa.some(function(a){a.explored=
!0;a.fog=0});k=c[11][7];ma(c[13][7],"inheritanceChest");I=ib(k);I.sort(U);l=I.splice(0,29);Ga(I,k);d=c[6][12];Ga(I,d);ma(d,"stair").draw=function(){};dc=5;f.setFogColor(0,0,50,.45)}else{f.setFogColor(0,0,27,.7);dc=0;for(var r=7+u(Math.floor(a/2)+1),p=20+3*Math.min(30,a),w=0;0<p;){for(l=u(r);0<=l;l--){nb(d);I.push(d);p--;var ba=[];d.left&&L(d.left.left)&&L(d.left.up)&&L(d.left.down)&&L(d.left.left)&&L(d.left.left.up)&&L(d.left.left.down)&&ba.push(d.left);d.right&&L(d.right.right)&&L(d.right.up)&&L(d.right.down)&&
L(d.right.right)&&L(d.right.right.up)&&L(d.right.right.down)&&ba.push(d.right);d.up&&L(d.up.up)&&L(d.up.left)&&L(d.up.right)&&L(d.up.up)&&L(d.up.up.right)&&L(d.up.up.left)&&ba.push(d.up);d.down&&L(d.down.down)&&L(d.down.left)&&L(d.down.right)&&L(d.down.down)&&L(d.down.down.right)&&L(d.down.down.left)&&ba.push(d.down);if(0===ba.length)break;d=E(ba);w++;if(10<w&&20>=w&&6===u(50)){w=100;aa.map(function(a){a.reset()});I.some(function(a){try{var c=2*(a.x-k.x)+k.x,b=2*(a.y-k.y)+k.y;yb(x.getTile(c,b));yb(x.getTile(c+
16,b));yb(x.getTile(c,b+16));yb(x.getTile(c+16,b+16))}catch(pd){}});I=ib(k);break}}d=E(I);p++}l=aa.filter(function(a){if(J(a))return!1;var c=J(a.left),b=J(a.right),d=J(a.up);a=J(a.down);return c&&b&&!d&&!a||!c&&!b&&d&&a});for(d=u(4);2>d&&!(1>l.length);d++)r=Fa(l),nb(r),I.push(r);l=I.filter(function(a){return 1>=a.neighborPassesCount()});d=u(Math.min(Math.round(a/3),5))-1;for(45===a&&(d=Math.max(3,d));0<d;d--)C(Fa(l),Math.ceil(3+u(Math.min(5,2*d))),u(2)?26+u(5):void 0);I=aa.filter(function(a){return!a.wall});
I=ib(k);I.sort(U);l=I.splice(0,8);d=I.pop();e?45!==a?ma(d,"stairLocked"):ma(d,"doorLocked"):ma(d,"stair");r=I.filter(function(a){return!J(a.left)&&!J(a.right)&&J(a.up)&&J(a.down)?!0:J(a.left)&&J(a.right)&&!J(a.up)&&!J(a.down)});for(d=0;3>d;d++)if(p=Fa(r))Ga(I,p),Ga(r,p.up),Ga(r,p.down),Ga(r,p.left),Ga(r,p.right),Ba(new sa(p));n=-90;F=16*Za+90;S=-90;T=16*mb+90;h=10-u(30)/10;v=h-u(30)/10;N=v-u(30)/10;Oa=u(20)}var t;if(e)r=I.pop(),t=Vc(r,Math.round(a/5)),t.cantDropItems||t.type.cantDropItems||wa(t,Z("skullKey"));
else{p=u(2)+2;d=u(Math.min(6,Math.max(1,a)))+Math.min(6,a);for(45<a&&(d+=a-45);0<=d;d--)r=Fa(I),r=Wa(r),r.type.amount&&(d-=r.type.amount-1),r&&(r.itemsToDrop&&0<r.itemsToDrop.length&&p--,!g.canCollectMoney()||r.type&&r.type.cantDropItems||r.cantDropItems||2!==u(4)||(14>K?wa(r,Z("moneySmall")):wa(r,Z(u(2)?"moneySmall":"moneyBig"))));for(;0<p;)ma(Fa(I)),p--}Hc(u());l&&(l.shift(),I=l.concat(I));I.some(function(a){if(a.image===x.floorType){var c=Ic(a.i,a.j);c>h?a.water=!0:c>v?(a.grass=1,u(100)<Oa?(Ga(I,
a),Ba(new Ca(a))):u(200)<Oa?wa(a,Z("seed")):15>u(100)&&wa(a,Z("dew"))):c>N&&(a.grass=2)}});lb();5<a&&1===a%5&&Ba(Z("shop",k));d=new g(k);Ac(d);Xa(d);0<K&&(d.y-=45,d.flySteps=30,d.sx=0,d.sy=1.5);e?(ra(m("BOSS_ALERT"),"#f40"),ra(m(t.type.name),"#f40")):ra(x.getLevelName());fa===Ha?ra(m("LATEST_ATTEMPT"),"#aaa"):1<fa&&ra(m("ATTEMPT").replace("%1",fa).replace("%2",Ha),"#aaa")},generateDungeon:function(a,c,b){0<e.length&&(e=[]);c||(c=0);try{this.generateDungeonSub(a,c)}catch(fc){if(130<c)throw Error("cant generate level");
this.generateDungeon(a,c+9,!0)}},explodeWall:function(a,c){a&&a.wall&&(a.wall=!1,a.mat1=x.floorMaterial,a.setType(c||80))},update:function(){hb&&(yc(),hb=!1,x.generateDungeon(K));la++;Tb=la&1;La=la&3?0:1;gc=la&7?0:1;ec=la&15?0:1;hc=la&31?0:1;Jb=la&63?0:1;xb=la&127?0:1;ic=la&255?0:1;d();La&&0<k&&(gc?w+=k:(w-=k,k--));for(var a,c=Y._listNext;c!==Y;){a=c._listNext;if(c.update())c.setTile&&c.setTile(void 0),ea(c);else if(c.y<c._listPrev.y){var b=c._listNext,e=c._listPrev;e._listPrev._listNext=c;c._listPrev=
e._listPrev;c._listNext=e;e._listPrev=c;e._listNext=b;b._listPrev=e}c=a}g.instance.flySteps&&g.instance.update();for(c=q._listNext;c!==q;)a=c._listNext,c.update()?(ea(c),c.setTile&&c.setTile(void 0)):c.y<c._listPrev.y&&(b=c._listNext,e=c._listPrev,e._listPrev._listNext=c,c._listPrev=e._listPrev,c._listNext=e,e._listPrev=c,e._listNext=b,b._listPrev=e),c=a;for(c=ca._listNext;c!==ca;){a=c._listNext;if(b=c.update())ea(c),"swapLayer"===b?Ba(c):c.setTile&&c.setTile(void 0);c=a}Wc()},draw:function(){Lb=
Math.max(1,Math.max(ya/(F-n),pa/(T-S)));h<Lb&&(h=Lb);var a=-n,d=-S,e=-F+ya/h,k=-T+pa/h;y>a&&(y=a);y<e&&(y=e);w>d&&(w=d);w<k&&(w=k);var a=Math.max(0,Math.ceil(-y/16)-2),d=Math.min(Za,Math.ceil((ya/h-y)/16)+1),e=Math.max(0,Math.ceil(-w/16)-2),k=Math.min(mb,Math.ceil((pa/h-w)/16)+1),v,m,N,l,U;if(0<K)for(v=a;v<d;v++)for(N=c[v],m=e;m<k;m++)l=N[m],l.explored&&l.image&&(U=l.shadow,p.drawImage(f.img(l.image,l.mat1,l.mat2,U),(l.x+y)*h,(l.y+w)*h,16*h,16*h),l.water?l.visible?p.drawImage(f.img(22+Math.floor((la+
2*v+3*m)/12)%4,x.waterMat1,x.waterMat2,U),(l.x+y)*h,(l.y+w)*h,16*h,16*h):p.drawImage(f.img(22,x.waterMat1,x.waterMat2,U),(l.x+y)*h,(l.y+w)*h,16*h,16*h):1===l.grass?p.drawImage(f.img(21,x.grassMat1,x.grassMat2),(l.x+y)*h,(l.y+w)*h,16*h,16*h):2===l.grass&&p.drawImage(f.img(20,x.grassMat1,x.grassMat2,U),(l.x+y)*h,(l.y+w)*h,16*h,16*h));for(v=Y._listNext;v!==Y;)v.visible&&v.draw(),v=v._listNext;0===K&&(m=g.instance,v=Math.round((y+m.x+3)*h),m=Math.round((w+m.y+8+A.walkPhases[m.walkPhase]/2)*h),N=p.getImageData(v,
m,Math.round(16*h),Math.round(8*h)),l=N.data,b(5,0,9,l),b(5,1,10,l),b(5,2,10,l),b(5,3,11,l),b(5,4,11,l),b(0,5,16,l),b(0,6,14,l),b(0,7,12,l),p.putImageData(N,v,m));for(v=q._listNext;v!==q;)v.visible&&v.draw(),v=v._listNext;for(v=ca._listNext;v!==ca;)v.visible&&v.draw(),v=v._listNext;for(v=a;v<d;v++)for(N=c[v],m=e;m<k;m++)l=N[m],l.image&&(!1!==l.thinFog&&p.drawImage(f.thinFog(l.thinFog),(l.x+y)*h,(l.y+w)*h,16*h,16*h),!1!==l.fog&&p.drawImage(f.fog(l.fog),(l.x+y)*h,(l.y+w)*h,16*h,16*h));g.instance.flySteps&&
g.instance.draw()},getClosestEnemy:function(a,c,b,d){var e,k,n;d*=d;for(var g=q._listNext;g!==q;)b!==g.team&&(k=a-g.x,n=c-g.y,k*=k,n*=n,k+=n,k<d&&(d=k,e=g)),g=g._listNext;return e}};x.clearDistances=N})();"use strict";var Rc;(function(){var a=[{name:"skillAttack",icon:{imgId:8,mat1:"iron",mat2:"wood"},apply:function(){gb++},isAvailable:function(){return!0},chance:1},{name:"skillDefence",icon:{imgId:48,mat1:"copper",mat2:"wood"},apply:function(){sb++},isAvailable:function(){return!0},chance:1},{name:"skillHP",
icon:{imgId:1,mat1:"garnet",mat2:"glass"},apply:function(){Qa+=5;g.instance.hp+=5},isAvailable:function(){return!0},chance:1},{name:"skillVision",icon:{imgId:13,mat1:"fur",mat2:"flesh"},apply:function(){xa++},isAvailable:function(){return 10>xa},chance:.5},{name:"skillInventory",icon:{imgId:39,mat1:"wood",mat2:"iron"},apply:function(){Ra+=5},isAvailable:function(){return g.transform&&g.transform.hasOwnProperty("capacityLimit")?Ra<g.transform.capacityLimit:40>Ra},chance:.6},{name:"Spear throughting +1",
icon:{imgId:44,mat1:"iron",mat2:"wood"},apply:function(){Sa++},isAvailable:function(){return g.instance.equiped.some(function(a){return a.isSpear})},chance:.5}],b,e;Rc=function(){Xb(Rb+83*oa);var d=a.filter(function(a){return a.isAvailable()&&u(1E3)/1E3<a.chance});b=Fa(d);e=Fa(d);r.prompt(q(null,q({style:{marginBottom:14,fontFamily:"Rubik One",fontSize:"130%",color:"#3d3"}},m("You reached level").replace("%",oa)),q({style:{marginBottom:14}},""),q({style:{marginBottom:14}},C({style:{color:"#3d3"}},
m(b.name))," - "+m(b.name+"_D")),q({style:{marginBottom:14}},C({style:{color:"#3d3"}},m(e.name))," - "+m(e.name+"_D"))),qa(b.icon,m(b.name)),function(){b.apply();g.instance.recalcStats()},qa(e.icon,m(e.name)),function(){e.apply();g.instance.recalcStats()},!0)}})();"use strict";var m,kc,lc,Xc;(function(){var a;lc=[{id:"def",name:"English"},{id:"ru",name:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439"}];var b={};lc.some(function(a){b[a.id]=a});kc=function(d,c){b.hasOwnProperty(d)||(d="def");z("language",
d);eb();Xc=d;var e=b[d];e.words?(a=e.words,c&&c()):Qb("data/locales/"+d+".txt",function(b){var d={};for(b=b.split("#");1<b.length;){var k=b.pop(),n=k.indexOf("\n"),g=k.substring(0,n).trim(),k=k.substring(n+1).trim();d[g]=k}e.words=d;a=e.words;c&&c()},!0)};m=function(b){return a.hasOwnProperty(b)?a[b]:b};var e=H("language");kc(e)})();"use strict";var M,Uc,mc,Yc;(function(){var a={},b={};qb(a);qb(b);var e,d,c,k;M=function(c,d,e,k){var n;a._listNext===a?n={x:c,y:d,update:e,draw:k,phase:10+u(10)}:(n=
wc(a),n.x=c,n.y=d,n.update=e,n.draw=k,n.phase=10+u(10));rb(b,n);return n};Uc=function(){for(;b._listNext!==b;){var n=wc(b);rb(a,n)}Zc();e||(n=f.mat("beam"),e=f.img(57,n,n),d=f.img(58,n,n),c=f.img(59,n,n),k=f.img(60,n,n))};mc=function(){for(var c=b._listNext,d;c!==b;)d=c._listNext,c.update()&&(ea(c),rb(a,c)),c=d};Yc=function(){for(var a=b._listNext;a!==b;)a.draw(),a=a._listNext};wb=function(){switch(this.phase){case 1:case 5:p.drawImage(e,(this.x+y)*h,(this.y+w)*h,16*h,16*h);break;case 3:p.drawImage(d,
(this.x+y)*h,(this.y+w)*h,16*h,16*h);break;case 2:case 6:p.drawImage(c,(this.x+y)*h,(this.y+w)*h,16*h,16*h);break;case 4:p.drawImage(k,(this.x+y)*h,(this.y+w)*h,16*h,16*h)}}})();var wb;"use strict";var ac;(function(){var a=function(){this.y-=.25*h;this.phase--;return 0>this.phase},b=function(){p.fillStyle=this.c;p.fillText(this.t,this.x,this.y)};ac=function(e,d,c,k){k||(k="#0f0");d=M((d+y)*h,(c+w)*h,a,b);d.phase=30+3*e.length;d.t=e;d.c=k}})();"use strict";var ra,Zc;(function(){var a,b,e=[],d,c=function(){var c;
if(0<this.phase)c=pa/2-22;else{if(this.y>=pa)return b=!1,e.length&&ra(e.shift(),e.shift()),!0;c=pa}a+=(c-this.y)/25;a*=.8;this.y+=a;this.phase--},k=function(){var a=p.font;p.font="44px Rubik One";p.fillStyle=d;p.fillText(this.t,this.x,this.y);p.font=a};Zc=function(){b=!1;e.length=0};ra=function(n,g){if(b)e.push(n),e.push(g);else{d=g?g:"#0f3";b=!0;a=0;var f=M(ya/2,-44,c,k);f.phase=30+9*n.length;f.t=n}}})();"use strict";var D,Wa,Vc,nc;(function(){var a,b=function(c){return c.chance<a?u(1E4)/1E4*a<=
c.chance:!0},e=function(c){c.chance&&c.chance>a&&(a=c.chance)};nc=function(c){a=0;c.some(e);return c.filter(b)};var d=[],c=[],k={},n,g;Wa=function(a,b){if(a){var d;b?d=k[b]:(n!==K&&(n=K,g=c.filter(function(a){if(45<K){var c=K-45+2;return 0<a.minLevel&&a.minLevel<3*c}return K<=a.maxLevel&&K>=a.minLevel})),d=nc(g),d=E(d));d||(d=k.Rat);d=new A(a,d);Xa(d);return d}};D=function(a){if(a.boss){if(d[a.boss])throw Error("Boss owerwriting "+a.boss);d[a.boss]=a}else c.push(a),k[a.name]=a,a.hasOwnProperty("chance")||
(a.chance=1)};Vc=function(a,c){var b=d[c];b||(b=d[d.length-1]);b=new A(a,b);Xa(b);return b}})();"use strict";var P;(function(){var a=[{condition:function(a){return"sword"===a.type.equipType&&"silver"===a.mat1.key&&"pens_aspen"===a.mat2.key},desc:"vapiricEffect",onAttack:function(a,b){X(g.instance,"regeneration",1)},priceAdd:1E3,priceMul:2.5},{condition:function(a){return"sword"===a.type.equipType&&"rustyIron"===a.mat1.key&&("wood"===a.mat2.key||"cinder"===a.mat2.key)},desc:"canBeBroken",onAttack:function(a,
b){Kb--;if(0>=Kb){Kb=500;var c=g.instance;c.say(this.getName()+" "+m("wasBroken"),"#f00");var d=qa(this,this.getName()+" "+m("WAS_BROKEN"));this.mat1=f.mat("broken");this.updateImg();c.recalcStats();c=qa(this,this.getName()+" "+m("WAS_BROKEN"));r.prompt(r.transitBlinking(d,c))}},priceAdd:0,priceMul:.5}],b=function(a){var b={};a.type.recalcStats&&(a.type.recalcStats(b,a),Object.keys(b).some(function(a){b[a]=0}),a.type.recalcStats(b,a));return b};P=function(a,b,c){B.call(this,a);cb=this.type=b;this.imgId=
W("imgId",36);c||(a=W("mat1","fur"),this.mat1=f.mat(a),a=W("mat2","flesh"),this.mat2=f.mat(a),b.onInit.call(this),this.updateImg())};P.prototype=new B;P.prototype.constructor=P;P.prototype.update=function(){var a=B.prototype.update.call(this);if(a)return a;!this.tile.water||"iron"!==this.mat1.key&&"iron"!==this.mat2.key||(this.rustyCounter?(this.rustyCounter++,1200<this.rustyCounter&&("iron"===this.mat1.key&&(this.mat1=f.mat("rustyIron")),"iron"===this.mat2.key&&(this.mat2=f.mat("rustyIron")),this.say(m("becomeRusty"),
"#666"),this.updateImg())):this.rustyCounter=1);if(this.type.update)return this.type.update.call(this)};P.prototype.callAction=function(a){a.action.call(this,g.instance)&&g.instance.consumeItem(this)};P.prototype.serialize=function(){var a=this.type.name+"@"+this.slot+"@"+this.mat1.key+"@"+this.mat2.key;this.hasOwnProperty("grade")&&(a+="@"+this.grade);return a};P.prototype.isUpgradable=function(){return!this.type.stackable};P.prototype.isSckableWith=function(a){return a.type.stackable&&a.type===
this.type&&a.mat1===this.mat1&&a.mat2===this.mat2};P.prototype.canEquip=function(){return this.type.equipType?!g.isSlotDisabled(this.type.equipType):!1};P.prototype.canEquipByLevel=function(){return oa>=this.getLevel()};P.prototype.getPrice=function(){var b=this.getValue();this.type&&(this.type.hasOwnProperty("priceMul")&&(b*=this.type.priceMul),this.type.hasOwnProperty("priceAdd")&&(b+=this.type.priceAdd));var d=this;a.some(function(a){a.condition(d)&&(a.hasOwnProperty("priceMul")&&(b*=a.priceMul),
a.hasOwnProperty("priceAdd")&&(b+=a.priceAdd))});return Math.max(1,Math.round(b))};P.prototype.getLevel=function(){var a;this.grade&&(a=this.grade,this.grade=0);var d=b(this);"undefined"!==typeof a&&(this.grade=a);return Math.max(1,Math.ceil(Math.max(d.defence?d.defence:0,d.power?d.power/2:0))-this.getGrade())};P.prototype.descItem=function(){var e=[];f.mat1amount(this.imgId)&&e.push(m(this.mat1.key));this.mat1!==this.mat2&&f.mat2amount(this.imgId)&&e.push(m(this.mat2.key));e=e.join(", ");this.burned&&
(e+=", "+m("burnt"));0<this.getGrade()&&(e+=", "+m("improved"));var d=b(this),c=[];Object.keys(d).some(function(a,b){var e=d[a];"boolean"===typeof e?c.push(C({key:"n"+b},m(a))):(c.push(C({key:"n"+b},m(a)+": ")),0<e?c.push(C({style:{color:"#0f0"},key:"v"+b},"+"+e)):c.push(C({style:{color:"#f00"},key:"v"+b},e)));c.push(ta({key:"b"+b}))});var k=this.getLevel(),n;1<k&&(n=q({style:{color:"#555"}},m("level:")+" "+k));this.type.desc&&("function"===typeof this.type.desc?(k=this.type.desc.call(this))&&c.push(C({key:"desc"},
"("+k+")")):c.push(C({key:"desc"},"("+m(this.type.desc)+")")),c.push(ta({key:"bdesc"})));var g=this;a.some(function(a){a.condition(g)&&c.push(q({key:"se_"+a.desc,style:{fontSize:"80%",color:"#456",margin:14}},m(a.desc)))});return q(null,q({style:{fontSize:"140%",color:"#0f0",marginBottom:5}},this.getName()),c,C({style:{color:"#678",fontSize:"80%"}},e),n)};P.prototype.onAttack=function(b,d){this.type.onAttack&&this.type.onAttack.call(this,b,d);var c=this;a.some(function(a){a.condition(c)&&a.onAttack.call(c,
b,d)})};P.prototype.getName=function(){return this.name?this.name:m(this.type.name)};P.prototype.onFire=function(a){this.type.onFire&&this.type.onFire.call(this,a);this.burned=!0;B.prototype.onFire.call(this,a)}})();"use strict";var l,ma,Z,Gb;(function(){var a={},b=[],e,d,c;Z=function(a,g,f){f=f||0;c||(b.some(function(a){a.chance/=k}),c=!0);var n;if(a)b.some(function(c){if(c.id===a)return n=c,!0});else{var h=K+f;e!==h&&(e=h,d=b.filter(function(a){return h<=a.maxLevel&&h>=a.minLevel}));n=E(d.filter(function(a){return u(1E4)/
1E4<=a.chance}));if(!n)return Z(a,g)}return new P(g,n)};ma=function(a,c){if(a){var b=Z(c,a);Ba(b);return b}};Gb=function(c){c=c.split("@");var b=a[c[0]];if(b){var d=new P(void 0,b,!0);d.mat1=f.mat(c[2]);d.mat2=f.mat(c[3]);d.burned="cinder"===c[2]||"cinder"===c[3];d.slot=parseInt(c[1]);b.onLoad&&b.onLoad.call(d);4<c.length&&(d.grade=parseInt(c[4]));d.updateImg();return d}};var k=1;l=function(c){c.chance>k&&(k=c.chance);c.chance||(c.chance=1);b.push(c);c.hasOwnProperty("onz")||(c.onz=0);a[c.name]=c}})();
"use strict";var Da="wood aspen pens_aspen bone iron gold bronze silver platinum".split(" ");(function(){l({name:"Sword",equipType:"sword",imgId:8,priceAdd:140,priceMul:2,onImgId:40,onx:0,ony:6,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"Club",equipType:"sword",imgId:96,onImgId:97,onx:-1,ony:9,minLevel:0,maxLevel:1E5,
recalcStats:function(a,b){a.power+=t(b,.6)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"Hammer",equipType:"sword",imgId:98,onImgId:99,priceAdd:100,priceMul:2,onx:-1,ony:6,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});
l({name:"Mace",equipType:"sword",imgId:100,onImgId:101,onx:-1,ony:5,minLevel:21,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"Knife",desc:"knifeDesc",equipType:"sword",imgId:7,priceAdd:30,priceMul:1.3,onImgId:92,onx:0,ony:6,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b,.3)},onInit:function(){this.mat1=f.matRandom(1,
2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onAttack:function(a,b){g.instance.delay=Math.round(.8*g.instance.delay)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"Knuckles",desc:"KnucklesDesc",equipType:"sword",imgId:94,priceAdd:80,priceMul:2.5,onImgId:95,onx:-1,ony:5,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b,.3)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(f.filterMatList(Da)))},onAttack:function(a,b){g.instance.delay=
Math.round(.6*g.instance.delay)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({chance:.25,name:"Long Sword",desc:function(){return m("CHANCETOCRIT").replace("%","20%")},equipType:"sword",priceAdd:400,priceMul:3,imgId:41,onImgId:42,onx:0,ony:6,minLevel:7,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(Da))},onAttack:Ec(20),onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({chance:.15,
name:"Broad Sword",desc:function(){return m("CHANCETOCRIT").replace("%","30%")},equipType:"sword",priceAdd:1300,priceMul:5,imgId:6,onImgId:43,onx:-2,ony:6,minLevel:30,maxLevel:1E5,onPickUp:function(){g.surprise("bSword")},recalcStats:function(a,b){g.surprise("bSword");a.power+=t(b)+5},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat(E(Da))},onAttack:Ec(30),onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){l({name:"Spear",isSpear:!0,
equipType:"sword",priceMul:2,imgId:44,onImgId:45,onx:1,ony:3,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.power+=t(b,.5)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat("wood")},onDamage:function(a,b,e,d){},onThrow:function(a){if(Sa){var b=u(Math.max(2,t(this))*Sa);return Vb(b,a,1,this.sx/3,this.sy/3,this)}},onDie:function(){},onFire:function(){}});l({name:"Trident",isSpear:!0,equipType:"sword",imgId:102,priceMul:4,onImgId:103,onx:-6,ony:3,minLevel:14,maxLevel:1E5,recalcStats:function(a,
b){a.power+=t(b,.7)},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat("wood")},onDamage:function(a,b,e,d){},onThrow:function(a){if(Sa){var b=u(Math.max(2,t(this))*Sa);return Vb(b,a,1,this.sx/3,this.sy/3,this)}},onDie:function(){},onFire:function(){}});l({name:"Shuriken",imgId:78,priceMul:2,minLevel:0,maxLevel:1E5,chance:.2,recalcStats:function(a,b){},onInit:function(){this.mat1=f.matRandom(1,2E6,3);this.mat2=f.mat("iron")},onDamage:function(a,b,e,d){},onThrow:function(a){var b=u(Math.max(2,
t(this))+gb);return Vb(b,a,1,this.sx/3,this.sy/3,this)},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a=[{matId:"garnet",recalc:function(a,c){a.maxHp+=t(c,2)},name:"of_HP"},{matId:"emerald",recalc:function(a,c){a.speed+=t(c,.5)/10},name:"of_speed",chance:.1},{matId:"ruby",recalc:function(a,c){},name:"of_Fire",chance:.1,desc:function(){return m("chanceToFire").replace("$",t(this,1))},onAttack:function(a,c){u(1E4)<100*t(this,1)&&R(void 0,a,3)}},{matId:"amber",recalc:function(a,
c){},name:"of_Paralyze",desc:function(){return m("chanceToParalize").replace("$",t(this,1))},onAttack:function(a,c){u(1E4)<100*t(this,1)&&a.tile&&Ea(a.tile,2)}},{matId:"opal",recalc:function(a,c){},name:"of_Poison",desc:function(){return m("chanceToPoison").replace("$",t(this,1.2))},onAttack:function(a,c){u(1E4)<100*t(this,1.2)&&a.tile&&Va(a.tile,8)}},{matId:"obsidian",recalc:function(a,c){a.defence+=t(c)},name:"of_defence"},{matId:"sapphire",recalc:function(a,c){a.power+=t(c)},name:"of_attack"}],
b={};a.some(function(a){b[a.matId]=a;a.hasOwnProperty("chance")||(a.chance=1)});var e=function(a,c){c.ringType.recalc(a,c)},d=function(){this.ringType=b[this.mat1.key];this.name=m(this.type.name)+" "+m(this.ringType.name)},c=function(){if(this.ringType.desc)return this.ringType.desc.call(this)},k=function(){this.mat1=f.mat(E(nc(a)).matId);this.mat2=f.matRandom(1,2E6,3);d.call(this)};l({name:"Simple Ring",equipType:"ring",imgId:3,priceMul:4,minLevel:0,maxLevel:1E5,recalcStats:e,desc:c,onInit:function(){k.call(this)},
onLoad:function(){d.call(this)},onAttack:function(a,c){this.ringType.onAttack&&this.ringType.onAttack.call(this,a,c)},onDamage:function(a,c,b,d){},onDie:function(){},onFire:function(){}});l({name:"Precious Ring",equipType:"ring",imgId:2,priceMul:7,minLevel:10,maxLevel:1E5,recalcStats:e,desc:c,onInit:function(){k.call(this)},onLoad:function(){d.call(this)},onAttack:function(a,c){this.ringType.onAttack&&this.ringType.onAttack.call(this,a,c)},onDamage:function(a,c,b,d){},onDie:function(){},onFire:function(){}});
l({name:"Rare Ring",equipType:"ring",imgId:5,priceMul:10,minLevel:20,maxLevel:1E5,recalcStats:e,desc:c,onInit:function(){k.call(this)},onLoad:function(){d.call(this)},onAttack:function(a,c){this.ringType.onAttack&&this.ringType.onAttack.call(this,a,c)},onDamage:function(a,c,b,d){},onDie:function(){},onFire:function(){}});l({name:"Kings Ring",equipType:"ring",imgId:4,priceMul:20,minLevel:30,maxLevel:1E5,recalcStats:e,desc:c,onInit:function(){k.call(this)},onLoad:function(){d.call(this)},onAttack:function(a,
c){this.ringType.onAttack&&this.ringType.onAttack.call(this,a,c)},onDamage:function(a,c,b,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a="leather fur iron gold bronze silver platinum".split(" ");l({name:"Armor",equipType:"armor",imgId:46,priceMul:2,onImgId:47,onx:0,ony:0,onz:-1,minLevel:5,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,e,d,c){},onDie:function(){},
onFire:function(){}});l({name:"LiteArmor",equipType:"armor",imgId:88,priceMul:2,onImgId:89,onx:0,ony:0,onz:-1,minLevel:0,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}});l({name:"PlateArmor",equipType:"armor",imgId:91,priceMul:2,onImgId:90,onx:0,ony:1,onz:-1,minLevel:18,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e)},onInit:function(){this.mat1=
f.matRandom(1,2E6,3);this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a="wood fur leather iron gold bronze silver platinum".split(" ");l({name:"Shield",equipType:"shield",imgId:48,onImgId:49,priceMul:3,onx:2,ony:4,minLevel:0,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e,.3)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.mat(E(f.filterMatList(a)))},onDamage:function(a,e,d,c){},onDie:function(){},
onFire:function(){}});l({name:"KnightsShield",equipType:"shield",imgId:83,priceMul:3,onImgId:85,onx:2,ony:4,minLevel:8,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e,.5)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}});l({name:"SpikedShield",equipType:"shield",imgId:86,priceMul:3,onImgId:87,onx:2,ony:4,minLevel:18,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e,.4);a.power+=
t(e,.3)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a="wood fur iron gold bronze silver platinum".split(" ");l({name:"Boots",equipType:"boots",imgId:50,priceMul:2,onImgId:51,onx:0,ony:0,onz:0,minLevel:0,maxLevel:1E5,recalcStats:function(a,e){a.defence+=t(e,.2)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(a)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,
e,d,c){},onDie:function(){},onFire:function(){}})})();"use strict";var oc="cotton fur leather iron bronze silver gold platinum".split(" ");(function(){l({name:"Pants",equipType:"pants",imgId:53,priceMul:2,onImgId:52,onx:0,ony:0,onz:0,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.defence+=t(b,.3)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(oc)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){l({name:"Helmet",
equipType:"helmet",imgId:54,priceMul:2,onImgId:55,onx:0,ony:0,onz:0,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.defence+=t(b,.2)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(oc)));this.mat2=f.mat(E(f.filterMatList(oc)))},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"GasMask",equipType:"helmet",stackable:1,imgId:128,priceMul:7,onImgId:129,onx:0,ony:0,onz:0,mat1:"leather",mat2:"iron",minLevel:3,maxLevel:1E6,chance:.3,recalcStats:function(a,b){b.burned||
(a.noToxic=!0,a.noParalize=!0)},onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});l({name:"VikingsHelmet",equipType:"helmet",imgId:104,priceAdd:200,priceMul:3,onImgId:105,onx:0,ony:0,onz:0,minLevel:22,maxLevel:1E5,recalcStats:function(a,b){a.defence+=t(b,.4);a.power+=t(b,.2)},onInit:function(){this.mat1=f.mat(E(f.filterMatList(Da)));this.mat2=f.matRandom(1,2E6,3)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){l({name:"Amulet",
equipType:"amulet",imgId:19,onImgId:56,onx:0,ony:3,onz:-1,minLevel:0,maxLevel:1E5,recalcStats:function(a,b){a.maxHp+=t(b)},onInit:function(){this.mat2=f.matRandom(1,2E6,3);u(2)?this.mat1=f.matRandom(1,2E6,3):this.mat1=f.matRandom(1,2E6,5)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";var pc;(function(){pc=function(a,c){0<a.hp&&O(new da(a,function(){var b=E(aa.filter(function(a){return a&&!a.wall&&!a.door&&!a.unit&&!a.visible}));b&&(a.setTile(b),a.x=b.x,a.y=
b.y,c&&c(),a===g.instance&&(x.clearDistances(),a.exploreTilesOnTeleport(),Ac(a)))}))};l({name:"Scroll of Expirience",desc:"INCHEROLEVEL",imgId:68,priceAdd:800,mat1:"emerald",mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,chance:.25,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){g.addXp(1E12);return!0}}]});l({name:"Scroll of Teleportation",desc:"TELEPORTHERO",imgId:69,priceAdd:160,
priceMul:5,mat1:"ink",mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){pc(a);return!0}}]});l({name:"Scroll of Fire",desc:"Burn all visible enemy",imgId:70,mat1:"ink",priceAdd:200,mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,
c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){var c=!1;aa.some(function(a){a.visible&&a.unit&&a.unit.hp&&1!==a.unit.team&&(a.unit.mat1.combustible||a.unit.mat2.combustible||"cinder"===a.unit.mat1.key||"cinder"===a.unit.mat2.key)&&(O(new da(a.unit)),R(void 0,a.unit,4),c=!0)});c||r.prompt(m("NOT_FIREABLE_ARROUND"));return c}}]});var a={name:"Statue",imgId:36,minLevel:-1,maxLevel:-1,hp:5,defence:2,power:1,lookDist:0,uih:0,atackDelay:1E7,speed:0,xp:1,mat1:"stone",mat2:"stone",
onInit:function(){},onDamage:function(a,c,b,e){},onFire:function(){},onDie:function(){this.preStoneType.onDie.call(this);this.delay=10;O(new qc(this))}};l({name:"Scroll of Stone",desc:"ScrolStoneDesc",imgId:111,priceAdd:900,mat1:"stone",mat2:"paper",minLevel:18,maxLevel:1E5,stackable:1,chance:.1,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(b){var c=!1;aa.some(function(b){if(b.visible&&
b.unit&&b.unit.hp&&1!==b.unit.team&&b.unit.type!==a){var d=b.unit;O(new da(d));d.mat1=f.mat("stone");d.mat2=d.mat1;d.updateImg();d.maxHp=5;d.hp=5;d.delay=1E7;d.speed=0;d.walkPhase=0;d.preStoneType=d.type;d.type=a;b=x.getTile(d.x+8,d.y+8);b.wall||b.unit||d.setTile(b);c=!0}});c||r.prompt(m("NO_UENEMY_ARROUND"));return c}}]});l({name:"Scroll of Madness",desc:"MADSCROLLDESC",imgId:79,priceAdd:400,mat1:"ink",mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,c){},onFire:function(){this.destroy()},
onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){var c=!1;aa.some(function(a){a.visible&&a.unit&&a.unit.hp&&1!==a.unit.team&&(O(new da(a.unit)),X(a.unit,"madness",20),c=!0)});c||r.prompt(m("NO_UENEMY_ARROUND"));return c}}]});l({name:"Scroll of Dreams",desc:"Lulls everyone around",imgId:71,priceAdd:150,mat1:"ink",mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},
onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){var c=A.wakeupAll=!1;aa.some(function(a){a.visible&&a.unit&&a.unit.hp&&1!==a.unit.team&&(O(new da(a.unit)),a.unit.sleep=!0,a.unit.delay=150,a.unit.say(.5<Math.random()?"z":"Z","#59c"),c=!0)});c||r.prompt(m("NO_UENEMY_ARROUND"));return c}}]});l({name:"Scroll of Mindvision",desc:"Allow you to see by enemies eyes",imgId:72,priceAdd:150,mat1:"ink",mat2:"paper",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,
c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){a=!1;for(var c=0,b=x.units._listNext;b!==x.units;)0<b.hp&&c++,b=b._listNext;if(1<c)for(b=x.units._listNext;b!==x.units;)0<b.hp&&(O(new da(b)),a=!0),b=b._listNext;a?g.mindVision=1200:r.prompt(m("NO_UENEMY_ONLEVEL"));return a}}]});l({name:"Scroll of Alchemy",desc:"Make any metalic item golden",imgId:68,priceAdd:2300,mat1:"gold",mat2:"paper",minLevel:0,
maxLevel:1E5,stackable:1,chance:.2,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){r.chooseItem(m("Choose item for Gilding"),function(a){g.instance.consumeItem(this);var c=f.mat1amount(a.imgId),b=f.mat2amount(a.imgId);0<c&&3===a.mat1.t&&"gold"!==a.mat1.key?a.mat1=f.mat("gold"):0<b&&3===a.mat2.t&&"gold"!==a.mat2.key&&(a.mat2=f.mat("gold"));a.updateImg();r.migicAnimateItem(a);
g.instance.recalcStats()}.bind(this),function(a){var c=f.mat1amount(a.imgId),b=f.mat2amount(a.imgId);return!a.type.stackable&&0<c&&3===a.mat1.t&&"gold"!==a.mat1.key||0<b&&3===a.mat2.t&&"gold"!==a.mat2.key})}}]});l({name:"Scroll of Upgrade",desc:"Improves item",imgId:68,priceAdd:500,priceMul:2,mat1:"ink",mat2:"paper",minLevel:3,maxLevel:1E5,stackable:1,chance:1,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",
action:function(a){r.chooseItem(m("Choose item to Improve"),function(a){g.instance.consumeItem(this);a.hasOwnProperty("grade")?a.grade++:a.grade=1;r.migicAnimateItem(a);g.instance.recalcStats()}.bind(this),function(a){return a.isUpgradable()})}}]});var b=function(a,c){!a||a.wall||a.unit||c.push(a)},e=function(a,c){var d=[],e=g.instance.tile;b(e.up,d);b(e.up.right,d);b(e.up.left,d);b(e.down,d);b(e.down.right,d);b(e.down.left,d);b(e.left,d);b(e.right,d);e=0<d.length?E(d):!1;if(!e)return r.prompt(m("NOT_ENOUGHT_FREE_SPACE")),
!1;d=Wa(e,a);e=d.tile;d.mat1=c;d.mat2=c;d.updateImg();d.team=1;d.sleep=!1;e.team=1;O(new da(d));e=t(d);d.defence+=e;d.power+=e;d.hp+=e;d.maxHp+=e;return!0};l({name:"Scroll of Summon",desc:"Summons evil creature",imgId:73,priceAdd:200,priceMul:2,mat1:"iron",mat2:"paper",minLevel:0,maxLevel:1E5,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){a=!1;for(var c=0;c<=this.getGrade();c++)a|=
e("Rat",this.mat1);return a}}]});l({name:"Scroll of Tower",desc:"Summons tower",imgId:75,priceAdd:100,priceMul:2,mat1:"iron",mat2:"paper",minLevel:0,maxLevel:1E5,recalcStats:function(a,c){},onFire:function(){this.destroy()},onInit:function(){},onDamage:function(a,c,b,e){},onThrow:function(a){},actions:[{name:"Read",action:function(a){a=!1;for(var c=0;c<=this.getGrade();c++)a|=e("Tower",this.mat1);return a}}]})})();"use strict";(function(){var a=function(a,d,c,k){g.surprise("explode");jc(d);b(a,d,
0,0);k&&k(a,d);d=Math.round(d/2);a.visibleTiles.some(function(e,g){if(g>c)return!0;k&&k(e,d);b(e,d,e.x-a.x,e.y-a.y)});A.wakeupAll=!0;lb()},b=function(a,b,c,k){a.unit?a.unit.damage(b,c,k):1<a.neighborPassesCount()&&x.explodeWall(a);ka(function(){Wb(a.x,a.y)},4*(Math.abs(c)+Math.abs(k)));a.onMove();a.units.some(function(a){if(a.onExplode)a.onExplode();a.type&&a.type.onExplode&&a.type.onExplode.call(a)})};l({name:"Bomb",imgId:76,mat1:"fur",priceAdd:100,priceMul:1.5,minLevel:7,maxLevel:1E5,recalcStats:function(a,
b){},onInit:function(){this.mat2=f.matRandom(1,2E6,3)},onExplode:function(){this.type.detonate.call(this,this.tile)},onDamage:function(a,b,c,k){},update:function(){if(this.detonated)return!0},detonate:function(b){if(!this.detonated){this.detonated=!0;var d=6+2*t(this),c=4+t(this);a(b,d,c)}},onThrow:function(a){this.type.detonate.call(this,a);return!0}});l({name:"Fire Bomb",imgId:76,mat1:"ruby",priceAdd:150,priceMul:1.5,minLevel:12,maxLevel:1E5,recalcStats:function(a,b){},onInit:function(){this.mat2=
f.matRandom(1,2E6,3)},onExplode:function(){this.type.detonate.call(this,this.tile)},onDamage:function(a,b,c,k){},update:function(){if(this.detonated)return!0},detonate:function(b){if(!this.detonated){this.detonated=!0;var d=6+2*t(this),c=4+t(this);a(b,d,c,function(a,c){R(a,a.unit,c)})}},onThrow:function(a){this.type.detonate.call(this,a);return!0}});l({name:"Shock Bomb",imgId:76,priceAdd:200,priceMul:1.5,mat1:"amber",minLevel:12,maxLevel:1E5,recalcStats:function(a,b){},onInit:function(){this.mat2=
f.matRandom(1,2E6,3)},onExplode:function(){this.type.detonate.call(this,this.tile)},onDamage:function(a,b,c,k){},update:function(){if(this.detonated)return!0},detonate:function(b){if(!this.detonated){this.detonated=!0;var d=6+2*t(this),c=4+t(this);a(b,d,c,function(a,c){Db(a,2*c)})}},onThrow:function(a){this.type.detonate.call(this,a);return!0}});l({name:"Dynamite with a timer",imgId:77,priceAdd:200,priceMul:1.5,mat1:"paper",minLevel:16,maxLevel:1E5,onPickUp:function(){this.activated&&(g.instance.say(m("Timer disabled"),
"#933"),delete this.activated)},recalcStats:function(a,b){},onInit:function(){this.mat2=f.matRandom(1,2E6,3)},onExplode:function(){this.type.detonate.call(this,this.tile)},onDamage:function(a,b,c,k){},detonate:function(b){if(!this.detonated){this.detonated=!0;b=10+2*t(this);var d=4+2*t(this);a(this.tile,b,2*d)}},update:function(){if(this.detonated)return!0;if(hc&&this.activated&&(this.say(""+this.activated--,"#933"),0>=this.activated))return this.type.detonate.call(this,this.tile),!0},actions:[{name:"Activate 5 sec",
action:function(a){this.activated=5;a.drop(this)}},{name:"Activate 10 sec",action:function(a){this.activated=10;a.drop(this)}}]})})();"use strict";(function(){function a(a){if(g.canCollectMoney()){var b;this.val||(b=this.getValue()*a,b+=this.rndVal%(b/2),b=Math.round(b));g.instance.say("+"+va(b),"#ff0");ha+=b;this.destroy();return!0}}l({name:"MoneySmall",id:"moneySmall",itsMoneyNoNeedSlot:!0,imgId:116,minLevel:-1,maxLevel:-1,onInit:function(){this.rndVal=u(123123);this.mat1=f.matRandom(1,2E6,3);this.mat2=
f.matRandom(1,2E6,3)},onPickUp:function(){return a.call(this,.04)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}});l({name:"moneyBig",id:"moneyBig",itsMoneyNoNeedSlot:!0,imgId:117,minLevel:-1,maxLevel:-1,onInit:function(){this.rndVal=u(123123);this.mat1=f.matRandom(1,2E6,3);this.mat2=f.matRandom(1,2E6,3)},onPickUp:function(){return a.call(this,.05)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){l({name:"HolyCross",desc:"HolyCrossD",
imgId:126,mat1:"bronze",mat2:"bronze",priceMul:15,minLevel:8,maxLevel:1E5,chance:.1,recalcStats:function(a,b){},onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){ka(function(){g.noGameover=!1;var a=g.instance;a.setTile(a.rip.tile);a.tile.door=!1;Xa(a);a.hp=a.maxHp;a.visible=!0;a.rip.destroy();O(new da(a))},2500);g.noGameover=!0;g.instance.consumeItem(this);return!0},onFire:function(){}})})();"use strict";(function(){l({id:"inheritanceChest",name:"inheritanceChest",notDisplayInInventory:!0,
imgId:152,onPickUp:function(){var a=H("inheritItem");a&&!this.getted?(this.getted=!0,a=Gb(a),a.setTile(this.tile),ia(a),a.dropped(this.tile)):r.prompt(qa(this,m("InheritChestLocked")));return!0},mat1:"wood",mat2:"copper",recalcStats:function(a,b){},onInit:function(){this.getted=!1},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a,b,e=React.createClass({displayName:"shop",getInitialState:function(){return{}},sellClick:function(){ha+=Math.round(b.getPrice()/
2);g.instance.drop(b);ea(b);b.setTile(null);this.props.items.push(b);this.forceUpdate();r.close()},sellAllClick:function(){var a=g.instance.getItemsCountAtSlot(b.slot);for(ha+=Math.round(b.getPrice()*a/2);a=g.instance.getItemAtSlot(b.slot);)g.instance.drop(a),ea(a),a.setTile(null),this.props.items.push(a);this.forceUpdate();r.close()},buyClick:function(){ha-=b.getPrice();g.instance.pickupItem(b);this.props.items.splice(this.props.items.indexOf(b),1);this.forceUpdate();r.close()},clickItem:function(c){b=
c;var d=c.getPrice();if("sell"===this.state.tab){var e,f=g.instance.getItemsCountAtSlot(c.slot);1<f&&(e=G(C({style:{color:"#fe0"}},m("sellAllFor").replace("%",va(Math.round(d*f/2)))),this.sellAllClick));r.clickItem(c,C(null,G(C({style:{color:"#fe0"}},m("sellFor").replace("%",va(Math.round(d/2)))),this.sellClick),e))}else d<=ha?(a||(a=ob(116,"gold","gold")),r.clickItem(c,G(C({style:{color:"#fe0"}},a,ta(),m("buyFor").replace("%",va(d))),this.buyClick))):r.clickItem(c,C({style:{color:"#a00"}},m("notEnoughtMoney").replace("%",
va(d))))},render:function(){var a;a=g.instance;switch(this.state.tab){case "sell":for(var b=this,d=[],e=g.getCapacity(),f=0;f<e;f++){var h=a.getItemAtSlot(f),l="",p;h?(l=h.mat1.key+"_"+h.mat2.key+"_"+h.imgId,p=va(Math.round(h.getPrice()/2))):p=l=void 0;d.push(C({key:l+"_"+f,style:{display:"inline-block",height:101,verticalAlign:"middle",margin:15}},Q({},"",h,a.getItemsCountAtSlot(f),function(){var a=h;return function(){b.clickItem(a)}}()),ta(),C({style:{color:"#fe0"}},p)))}a=q(null,d);break;default:this.props.items.sort(function(a,
c){return c.getPrice()-a.getPrice()}),a=this.props.items.map(function(a,c){return C({key:a.mat1.key+"_"+a.mat2.key+"_"+a.imgId+"-"+c,style:{display:"inline-block",margin:15}},Q({},"",a,1,this.clickItem),ta(),C({style:{color:"#fe0"}},va(a.getPrice())))}.bind(this))}return q(null,q({style:{padding:20,color:"#8ac",fontSize:"130%",textAlign:"center",borderBottom:"3px solid #234"}},m("StoreTitle")),q({style:{margin:10,textAlign:"center",borderBottom:"3px solid #234"}},G(m("Buying"),this.state.tab?function(){this.setState({tab:""})}.bind(this):
void 0),G(m("Selling"),"sell"===this.state.tab?void 0:function(){this.setState({tab:"sell"})}.bind(this))),q({style:{position:"relative"}},C({style:{position:"absolute",display:"inline-block",left:10,top:-4,color:"#fe0",fontSize:"90%"}},m("money")+": "+va(ha)),q({style:{width:550,display:"inline-block",verticalAlign:"middle"}},a),pb({src:"data/shoper.png",style:{width:256,height:352,verticalAlign:"middle"}})))}}),d=function(a){return a&&a.wall&&a.up&&a.up.wall&&a.up.left&&a.up.left.wall&&a.up.right&&
a.up.right.wall&&a.left&&a.left.wall&&a.right&&a.right.wall&&a.down&&!a.down.wall&&!a.down.door};D({name:"angryShoper",imgId:120,minLevel:-1,maxLevel:-1,hp:300,defence:40,power:20,lookDist:5,uih:0,atackDelay:30,speed:.6,xp:20,mat1:"flesh",mat2:"fur",onInit:function(){this.delay=90},onLogic:function(){if(!this.said||.8<Math.random())this.say(m(.5<Math.random()?"angryShoper1":"angryShoper2"),"#f00"),this.delay=10,this.said=!0},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(a){}});l({name:"shop",
notDisplayInInventory:!0,id:"shop",imgId:118,minLevel:-1,maxLevel:-1,onExplode:function(){var a=this.tile;this.destroy();Wa(a,"angryShoper")},onInit:function(){this.mat1=x.wallMaterial;this.mat2=x.floorMaterial;var a=E(this.tile.visibleTiles.filter(d));a||(a=E(aa.filter(d)));if(!a)throw Error("cant place shop");this.setTile(a);nb(a);lb();this.x=a.x;this.y=a.y-1;this.updateImg();this.items=[];this.items.push(Z("healpotion"));for(a=0;9>a;a++)this.items.push(Z())},onPickUp:function(){this.burned?r.prompt(qa(this,
m("Shop was burned"))):r.open(0,0,0,React.createElement(e,{items:this.items}));return!0},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){var a={id:"stair",name:"Stair",notDisplayInInventory:!0,imgId:35,onPickUp:function(){Fc();return!0},recalcStats:function(a,b){},onInit:function(){this.mat1=this.tile.mat1;this.mat2=f.wallMat()},onDamage:function(a,b,c,k){},onDie:function(){},onFire:function(){}};l(a);var b=function(){var b=g.instance.getItemById("skullKey");
b?(g.instance.consumeItem(b),g.instance.say(m("unlocked"),"#555"),this.type=a,this.imgId=a.imgId,this.updateImg()):!this.type.noPassable&&g.transform&&g.transform.canPassLockedDoor?r.prompt(qa(this,q(null,q(null,m("Entrance is locked.")),q(null,m("DoYouWantPassCage")))),m("Yes"),Fc,m("No")):r.prompt(qa(this,m("Entrance is locked.")));return!0};l({id:"stairLocked",notDisplayInInventory:!0,name:"Locked Stair",imgId:64,onPickUp:b,recalcStats:function(a,b){},onInit:function(){this.mat1=this.tile.mat1;
this.mat2=f.wallMat()},onDamage:function(a,b,c,k){},onDie:function(){},onFire:function(){}});l({id:"doorLocked",notDisplayInInventory:!0,name:"Locked Door",imgId:151,noPassable:!0,onPickUp:b,mat1:"iron",mat2:"gold",recalcStats:function(a,b){},onInit:function(){},onDamage:function(a,b,c,k){},onDie:function(){},onFire:function(){}})})();"use strict";var Ma,Ea;(function(){var a=function(a){a&&a.unit&&(a.unit.say(m("debuff"),"#a80"),a.unit.removeBadEffects())},b=function(a,b){r.prompt(qa(a,m("DRINK PROMPT")+
" "+a.getName()+"?"),m("Yes i know"),b,m("No"))},e=function(a){a&&a.unit&&(a.unit.say(m("speed up"),"#a80"),X(a.unit,"speedup",20))};Ea=function(a,b){a&&a.unit&&!a.unit.noParalize&&(X(a.unit,"paralize",b||9),a.unit.say(m("paralized"),"#a80"))};Ma=function(a,b){a&&a.unit&&(X(a.unit,"invisible",b||20),a.unit.say(m("invisible"),"#aaa"))};var d=function(a){a&&(ac("+",a.x+8,a.y+8,"#0a0"),a.unit&&(a.unit.hp=a.unit.maxHp,a.unit.removeBadEffects()))};l({name:"Heal Potion",id:"healpotion",imgId:1,priceAdd:300,
priceMul:0,mat1:"garnet",mat2:"glass",minLevel:0,maxLevel:1E5,stackable:1,chance:4,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){d(a);d(a.up);d(a.down);d(a.left);d(a.right);for(var c=15;0<c;){var b=M(a.x+8,a.y+8,Ia,Sb);b.xs=-2+4*Math.random();b.ys=-2+4*Math.random();c--}return!0},actions:[{name:"Drink",action:function(a){a.removeBadEffects();a.hp=a.maxHp;a.say("+ + +","#0a0");return!0}}]});l({name:"Antidote Potion",
desc:"ANTIDOTE_DESC",imgId:1,priceAdd:120,priceMul:0,mat1:"sapphire",mat2:"glass",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(c){a(c);a(c.up);a(c.down);a(c.left);a(c.right);for(var b=15;0<b;){var d=M(c.x+8,c.y+8,Ia,Sb);d.xs=-2+4*Math.random();d.ys=-2+4*Math.random();b--}return!0},actions:[{name:"Drink",action:function(c){a(c.tile);return!0}}]});l({name:"Honey Potion",id:"honeypotion",
imgId:119,priceAdd:400,priceMul:0,mat1:"honey",mat2:"glass",minLevel:-1,maxLevel:-1,stackable:1,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){return!0},actions:[{name:"Drink",action:function(a){this.burned?Va(a.tile,5):(e(a.tile),a.removeBadEffects(),a.hp=a.maxHp,a.say("+ + +","#0a0"));return!0}}]});l({name:"Potion of Speed",id:"speedpotion",imgId:1,priceAdd:300,priceMul:0,mat1:"opal",mat2:"glass",minLevel:0,maxLevel:1E5,
stackable:1,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){e(a);e(a.up);e(a.down);e(a.left);e(a.right);for(var c=15;0<c;){var b=M(a.x+8,a.y+8,Ia,Ua);b.xs=-2+4*Math.random();b.ys=-2+4*Math.random();c--}return!0},actions:[{name:"Drink",action:function(a){e(a.tile);return!0}}]});l({name:"Potion of Invisibility",id:"invispotion",imgId:1,priceAdd:200,priceMul:0,mat1:"silver",mat2:"glass",minLevel:0,maxLevel:1E5,stackable:1,
recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){Ma(a);Ma(a.up);Ma(a.down);Ma(a.left);Ma(a.right);for(var c=15;0<c;){var b=M(a.x+8,a.y+8,Ia,Ua);b.xs=-2+4*Math.random();b.ys=-2+4*Math.random();c--}return!0},actions:[{name:"Drink",action:function(a){Ma(a.tile);return!0}}]});l({name:"Paralytic Gas",id:"paralyzepotion",imgId:106,priceAdd:400,priceMul:0,mat1:"amber",mat2:"glass",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,
b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){Ea(a);Ea(a.up);Ea(a.down);Ea(a.left);Ea(a.right);for(var c=15;0<c;){var b=M(a.x+8,a.y+8,Ia,Ua);b.xs=-2+4*Math.random();b.ys=-2+4*Math.random();c--}return!0},actions:[{name:"Drink",noFastShortcut:!0,action:function(a){b(this,function(){a.consumeItem(this);Ea(a.tile)}.bind(this))}}]});l({name:"Fire Potion",id:"firepotion",imgId:106,priceAdd:150,priceMul:0,mat1:"ruby",mat2:"glass",minLevel:0,
maxLevel:1E5,stackable:1,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){R(a,a.unit,10);R(a.up,a.up.unit,5);R(a.down,a.down.unit,5);R(a.left,a.left.unit,5);R(a.right,a.right.unit,5);g.surprise("firePotion");return!0},actions:[{name:"Drink",noFastShortcut:!0,action:function(a){b(this,function(){a.consumeItem(this);R(void 0,a,4)}.bind(this))}}]});l({name:"Toxic Potion",id:"toxicpotion",imgId:106,priceAdd:200,priceMul:0,
mat1:"emerald",mat2:"glass",minLevel:0,maxLevel:1E5,stackable:1,recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){ua(a,30);return!0},actions:[{name:"Drink",noFastShortcut:!0,action:function(a){b(this,function(){a.consumeItem(this);ua(a.tile,30)}.bind(this))}}]});l({name:"Dew",id:"dew",imgId:107,mat1:"dew",mat2:"glass",minLevel:-1,maxLevel:-1,onFire:function(){O(new Na(this));this.destroy()},onPickUp:function(){g.instance.say(this.getName(),
"#555");X(g.instance,"regeneration",1);this.destroy();return!0},recalcStats:function(a,b){},onInit:function(){},onExplode:function(){this.destroy()},onDamage:function(a,b,d,e){},onThrow:function(a){ua(a,30);return!0}})})();"use strict";(function(){l({id:"skullKey",name:"Skull Key",priceAdd:NaN,imgId:65,minLevel:-1,maxLevel:-1,mat1:"silver",mat2:"copper",recalcStats:function(a,b){},onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";var bc;(function(){var a,
b=function(){if(gc){if(1.6>this.speed)this.speed+=.1;else return!0;this.imgPhase++;switch(this.imgPhase&3){case 0:this.imgId=141;break;case 2:this.imgId=143;break;default:this.imgId=142}B.prototype.updateImg.call(this)}},e={stone:{speed:3,imgId:66,mat1:"brick",onInit:function(){},onDamage:function(){}},arrowPoisoned:{speed:3,imgId:146,mat1:"wood",mat2:"iron",onInit:function(){},onDamage:function(){7>u(100)&&Va(this.target.tile,30)}},tpMagic:{speed:-.3,imgId:141,mat1:"beam",onInit:function(){this.imgPhase=
0},onDamage:function(){pc(this.target)},onLogic:b},magic:{speed:-.2,imgId:141,mat1:"sapphire",onInit:function(){this.imgPhase=0},onDamage:function(){},onLogic:b},roots:{speed:0,imgId:145,mat1:"wood",onInit:function(){},onDamage:function(){},onLogic:function(){return!vb(this.target,"rooting")}}};bc=function(b,c,e,g,f){b=new a(b,c,e,g,f);ia(b);return b};a=function(a,c,b,g,h){this.target=c;this.visible=!0;a=e[a];this.speed=a.speed;cb=this.type=a;this.x=b;this.y=g;this.imgId=W("imgId",36);this.pow=h;
c=W("mat1","wood");this.mat1=f.mat(c);c=W("mat2","iron");this.mat2=f.mat(c);a.onInit.call(this);B.prototype.updateImg.call(this)};a.prototype.update=function(){var a=this.target.x-this.x,c=this.target.y-this.y,b=this.speed;if(Math.abs(a)<b&&Math.abs(c)<b)return b=u(this.pow+1)-u(this.target.defence+1),this.target.damage(b,a,c,this),this.type.onDamage.call(this),!0;b=Math.sqrt(a*a+c*c)/b;this.x+=a/b;this.y+=c/b;if(this.type.onLogic)return this.type.onLogic.call(this)};a.prototype.draw=B.prototype.draw})();
"use strict";(function(){var a=["ruby","emerald","garnet","amber","opal"],b=["Fireflower seed","Toxicflower seed","Healgrass seed","Paraligrass seed","Poisongrass seed"];l({id:"seed",name:"seed",mat2:"stem",priceAdd:10,priceMul:0,imgId:82,minLevel:-1,maxLevel:-1,stackable:1,recalcStats:function(a,b){},onInit:function(){var e=u(a.length);this.mat1=f.mat(a[e]);this.name=m(b[e])},onLoad:function(){this.name=m(b[a.indexOf(this.mat1.key)])},onDamage:function(a,b,c,k){},onDie:function(){},onFire:function(){this.destroy()},
onThrow:function(a){var b=new Ca(a,this.mat1.key);b.mat2=this.mat2;Ba(b);a.grass=2;b.updateImg();return!0},actions:[{name:"Plant",noFastShortcut:!0,action:function(a){this.type.onThrow.call(this,a.tile);return!0}}]})})();"use strict";var R;(function(){var a=function(b,d,c){b&&(b.gas&&b.gas.fireable&&(delete b.grass,delete b.water,b.hasOwnProperty("fire")?10>b.fire.pow&&(b.fire.pow=10):(R(b,void 0,10),a(b.up),a(b.down),a(b.left),a(b.right))),!b.water&&b.grass&&(delete b.grass,R(b,void 0,3)),b.units.some(function(a){a===
d||b.water&&!a.isFly||!(a.mat1.combustible||a.mat2.combustible||("cinder"===a.mat2.key||"cinder"===a.mat1.key)&&0<a.hp)||!c&&!a.lockedTile||(a.hasOwnProperty("fire")?4>a.fire.pow&&(a.fire.pow=4+u(4)):(a.onFire(this),a.tile&&R(void 0,a,2+u(2))))}))};R=function(a,d,c){(d&&d.tile||a&&!a.wall)&&O(new b(a,d,c))};var b=function(a,b,c){this.pow=c;a?(a.image=33,a.mat2=f.mat("cinder"),this.tile=a,a.fire=this):(this.tile=b.tile,this.unit=b,this.unit.fire=this)};b.prototype.unitDead=function(){this.pow=2;delete this.unit};
b.prototype.draw=function(){};b.prototype.update=function(){if(this.unit){if(this.unit.tile)this.tile=this.unit.tile;else{this.unitDead();return}this.tile.visible&&M(this.unit.x+2+12*Math.random(),this.unit.y+12*Math.random(),tb,Bb);if(this.tile.water&&!this.unit.isFly)return O(new Na(this.unit)),delete this.unit.fire,!0}else this.tile||(this.tile=x.getTile(this.x,this.y)),this.tile.visible&&M(this.tile.x+16*Math.random(),this.tile.y+16*Math.random(),tb,Bb);a(this.tile,this.unit,!0);if(Jb){if(!this.unit||
this.unit.lockedTile)a(this.tile.up),a(this.tile.down),a(this.tile.left),a(this.tile.right);if(this.unit)this.unit.onFire(this);this.pow--;if(0>this.pow)return this.unit?delete this.unit.fire:delete this.tile.fire,!0}}})();"use strict";var Na,da,qc,rc;(function(){qc=function(a,b){this.pow=17;this.unit=a;this.particleDraw=b||Ua};qc.prototype.update=function(){this.unit.visible&&M(this.unit.x+2+12*Math.random(),this.unit.y+this.pow,ed,this.particleDraw);this.pow--;return 0>this.pow};rc=function(a,b){this.pow=
25;this.tile=a.tile;this.particleDraw=b||gd};rc.prototype.update=function(){this.tile.visible&&M(this.tile.x+2+12*Math.random(),this.tile.y+16,Bc,this.particleDraw);this.pow--;return 0>this.pow};Na=function(a,b){this.pow=17;this.unit=a;this.particleDraw=b||Ua};Na.prototype.update=function(){this.unit.visible&&M(this.unit.x+2+12*Math.random(),this.unit.y+12*Math.random(),tb,this.particleDraw);this.pow--;return 0>this.pow};da=function(a,b){this.pow=255;this.unit=a;this.visible=!0;this.callback=b};da.prototype.draw=
function(){if(this.unit.visible){var a=255-Math.abs(this.pow);p.fillStyle="rgb("+a+","+a+",255)";var b=this.pow/30,a=a/54,e=Math.cos(b)*a*2,b=Math.sin(b)*a*2,d=2*a*h;p.fillRect((this.unit.x+y+8+e-a)*h,(this.unit.y+w+8+b-a)*h,d,d);p.fillRect((this.unit.x+y+8-e-a)*h,(this.unit.y+w+8-b-a)*h,d,d)}};da.prototype.update=function(){this.pow-=8;this.callback&&0>this.pow&&(this.callback(),this.callback=void 0);return-255>this.pow}})();"use strict";var Oc;(function(){Oc=function(b){Ba(new a(b))};var a=function(a){this.x=
a.x+8;this.y=a.y+16-8+a.uih;this.phase=20;this.visible=!0};a.prototype.draw=function(){p.fillStyle="rgba(120,0,0,"+this.phase/6+")";var a=(8-this.phase/3)*h;p.fillRect((this.x+y)*h-a,(this.y+w)*h,2*a,a)};a.prototype.update=function(){this.phase-=.1;return 0>=this.phase}})();"use strict";var ua;(function(){ua=function(a,d){O(new b(a,d))};var a=function(a,b){!a||a.wall||a.door||a.gas||ua(a,b-2)},b=function(a,b){this.fireable=!0;this.pow=b;this.tile=a;a.gas=this};b.prototype.draw=function(){};b.prototype.update=
function(){this.tile.visible&&M(this.tile.x+16*Math.random(),this.tile.y+16*Math.random(),Bc,hd);if(hc){if(this.tile.door)return delete this.tile.gas,!0;var b=this;this.tile.units.some(function(a){a.noToxic||(a.hp&&a.damage(1,0,0,b),a.mat1.onToxic&&a.mat1.onToxic.call(a,b),a.mat2.onToxic&&a.mat2.onToxic.call(a,b))});12<this.pow&&(a(this.tile.left,this.pow),a(this.tile.right,this.pow),a(this.tile.up,this.pow),a(this.tile.down,this.pow));this.pow--;if(0>this.pow)return delete this.tile.gas,!0}};Kc(function(){f.mat("fur").onToxic=
function(a){15<a.pow&&this.replaceMat("fur","toxicFur")};f.mat("toxicFur").onEquip=function(a){Va(this.tile,5)};f.mat("toxicFur").onDie=function(){ua(this.tile,15)};f.mat("toxicFur").onThrow=function(a){ua(a,15);.333333>Math.random()&&this.replaceMat("toxicFur","fur")};f.mat("cotton").onToxic=function(a){15<a.pow&&this.replaceMat("cotton","toxicCotton")};f.mat("toxicCotton").onDie=function(){ua(this.tile,15)};f.mat("toxicCotton").onEquip=function(a){Va(this.tile,3)};f.mat("toxicCotton").onThrow=function(a){ua(a,
13);.333333>Math.random()&&this.replaceMat("toxicCotton","cotton")}})})();"use strict";var Ca;(function(){var a;Ca=function(b,e){a||(a=[{m:f.mat("ruby"),f:function(){R(this.tile,void 0,2)},imgId:34},{m:f.mat("emerald"),f:function(){ua(this.tile,this.pow+16)},imgId:34},{m:f.mat("garnet"),f:function(){this.tile.unit&&X(this.tile.unit,"regeneration",this.pow+4)},imgId:84},{m:f.mat("amber"),f:function(){Ea(this.tile,this.pow+4)},imgId:34},{m:f.mat("opal"),f:function(){Va(this.tile,this.pow+3)},imgId:84}]);
this.pow=u(10);e=e?a.filter(function(a){return a.m.key===e}).pop():E(a);this.imgId=e.imgId;this.mat1=e.m;this.onTouch=e.f;this.mat2=f.mat("stem");this.updateImg();B.call(this,b);this.prevUnitsCount=this.tile.units.length;b.flower=this};Ca.prototype=new B;Ca.prototype.constructor=Ca;Ca.prototype.onFire=function(){this.burned||(B.prototype.onFire.call(this),R(this.tile,void 0,4),this.delay=100,this.burned=!0)};Ca.prototype.onExplode=function(){this.onTouch();delete this.tile.flower;this.destroy()};
Ca.prototype.update=function(){B.prototype.update.call(this);if(this.delay)this.delay--;else{if(this.burned)return delete this.tile.flower,!0;this.prevUnitsCount<this.tile.units.length?(this.onTouch(),this.burned=!0):this.prevUnitsCount=this.tile.units.length}}})();"use strict";var $c=function(){var a=g.instance.x,b=g.instance.y,e,d=0,c,k;this.forEachVisibleTile(10,function(g){g.unit||g.wall||(c=g.x-a,k=g.y-b,c=c*c+k*k,c>d&&(d=c,e=g))});e&&this.setTile(e);return e};(function(){D({name:"Guediarra",
imgId:63,boss:1,minLevel:-1,maxLevel:-1,hp:45,defence:2,power:3,lookDist:4,uih:-2,atackDelay:30,speed:.7,xp:10,mat1:"chitin",mat2:"copper",onAttack:Dc(20,1),onInit:function(){g.surprise("firstBoss")},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){}});var a,b,e,d=["firepotion","paralyzepotion","toxicpotion"],c=["healpotion","speedpotion","invispotion"],k=function(a,b){if(e){var c=ma(a,b);this.throwItem(c,a.x,a.y);c.visible=!0;e--}},f=function(e){if(this.isEnemyHere(e)){switch(a){case 0:a++;
k.call(this,e,"firepotion");this.delay=90;break;case 1:a++;k.call(this,e,"paralyzepotion");b=10;break;case 2:a++;$c.call(this);break;case 3:33<u(100)?k.call(this,e,E(d)):this.tile.right.team?k.call(this,e,E(d)):k.call(this,this.tile.right,E(c)),a=2,b=9+u(3)}return h=!0}},h;D({name:"Potionello",imgId:81,boss:2,minLevel:-1,maxLevel:-1,hp:60,defence:3,power:4,lookDist:6,uih:-1,atackDelay:30,speed:.7,xp:15,mat1:"iron",mat2:"copper",onInit:function(){e=8;a=0;this.sleep=!1;this.noParalize=this.noToxic=
!0},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){},onLogic:function(){if(b)b--;else return h=!1,this.forEachVisibleTile(this.lookDist,f.bind(this)),h}})})();"use strict";(function(){D({name:"Snake",imgId:38,minLevel:3,maxLevel:5,hp:8,defence:1,power:2,lookDist:3,uih:2,atackDelay:60,speed:.25,xp:2,mat1:"squama",onInit:function(){8<u(10)?this.mat2=f.mat("ruby"):this.mat2=f.mat("meat")},onAttack:Ub(40,7),onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}});D({name:"Snake",
imgId:38,minLevel:43,maxLevel:44,hp:8,defence:1,power:2,lookDist:3,uih:2,atackDelay:60,speed:.25,xp:2,mat1:"squama",onInit:function(){8<u(10)?this.mat2=f.mat("ruby"):this.mat2=f.mat("meat")},onAttack:Ub(40,7),onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){D({name:"Rat",imgId:36,minLevel:0,maxLevel:5,hp:5,defence:0,power:1,lookDist:5,uih:6,atackDelay:60,speed:.25,xp:1,mat1:"fur",mat2:"flesh",cantDropItems:!0,onInit:function(){},onDamage:function(a,
b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"Rat",imgId:36,minLevel:0,maxLevel:1E7,hp:5,defence:0,power:1,lookDist:5,uih:6,atackDelay:60,speed:.25,xp:1,mat1:"fur",mat2:"flesh",chance:.06,cantDropItems:!0,onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"Rat",imgId:36,minLevel:41,maxLevel:44,hp:5,defence:0,power:1,lookDist:5,uih:6,atackDelay:60,speed:.25,xp:1,mat1:"fur",mat2:"flesh",cantDropItems:!0,onInit:function(){},onDamage:function(a,
b,e,d){},onDie:function(){},onFire:function(a){}})})();"use strict";(function(){D({name:"Morlok",imgId:61,minLevel:11,maxLevel:15,hp:15,defence:3,power:3,lookDist:5,uih:0,atackDelay:60,speed:.5,xp:3,mat1:"squama",mat2:"flesh",onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"Skelegator",amount:3,imgId:93,minLevel:12,maxLevel:15,hp:45,defence:3,power:2,lookDist:5,uih:0,atackDelay:10,speed:.5,xp:12,mat1:"bone",mat2:"iron",chance:.2,onInit:function(){},
onDamage:function(a,b,e,d){},onDie:function(){O(new Na(this,Cc))},onFire:function(a){}})})();"use strict";(function(){D({name:"Spider",imgId:62,minLevel:6,maxLevel:10,hp:5,defence:2,power:3,lookDist:4,uih:3,atackDelay:40,speed:.5,xp:1,mat1:"chitin",mat2:"meat",onAttack:Dc(20,1),onInit:function(){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){}})})();"use strict";(function(){D({name:"Scrapper",imgId:67,bullet:"stone",shootDist:3,minLevel:8,maxLevel:10,hp:5,defence:2,power:2,lookDist:6,
uih:-1,atackDelay:80,speed:.5,xp:2,mat1:"flesh",mat2:"rustyIron",onInit:function(){},onShoot:function(a){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"Tower",imgId:74,bullet:"stone",shootDist:4,minLevel:-1,maxLevel:-1,hp:10,defence:2,power:2,lookDist:4,uih:-1,atackDelay:80,speed:0,xp:3,mat1:"iron",mat2:"wood",onInit:function(){var a=this;this.sleep=!1;this.tile.visibleTiles.some(function(b){if(!b.unit&&b.wall)return a.setTile(b),a.x=b.x,a.y=b.y,!0})},onShoot:function(a){},
onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}})})();"use strict";(function(){D({name:"Bloodsucker",amount:3,imgId:108,minLevel:12,maxLevel:15,hp:15,defence:4,power:5,lookDist:6,uih:1,atackDelay:50,speed:.125,xp:4,mat1:"chitin",mat2:"bone",chance:.5,onInit:function(){},onAttack:function(a,b){X(this,"regeneration",b)},onDamage:function(a,b,e,d){},onDie:function(){ub(this,"BloodsuckerSmall",2)},onFire:function(a){}});D({name:"BloodsuckerSmall",imgId:109,minLevel:10,maxLevel:15,
hp:10,defence:3,power:3,lookDist:6,uih:4,atackDelay:30,speed:.5,xp:3,mat1:"chitin",mat2:"bone",cantDropItems:!0,onInit:function(){},onAttack:function(a,b){X(this,"regeneration",b)},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"BloodsuckerBoss",boss:3,imgId:110,minLevel:-1,maxLevel:-1,hp:70,defence:5,power:15,lookDist:6,uih:0,atackDelay:80,speed:.3,xp:20,mat1:"meat",mat2:"bone",onInit:function(){},onAttack:function(a,b){X(this,"regeneration",Math.round(b/2))},onDamage:function(a,
b,e,d){},onDie:function(){try{ub(this,"Bloodsucker",2),ub(this,"BloodsuckerSmall",20)}catch(a){}},onFire:function(a){}})})();"use strict";(function(){var a;D({name:"Bear",amount:5,imgId:115,minLevel:17,maxLevel:20,hp:50,defence:5,power:8,lookDist:5,uih:-1,atackDelay:70,speed:.25,xp:14,mat1:"fur",mat2:"leather",chance:.2,onInit:function(){},onLogic:function(){3!==this.team&&this.targetTile&&(this.team=3)},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(a){}});D({name:"Bee",amount:.333,
imgId:113,minLevel:16,maxLevel:20,hp:3,defence:0,power:9,lookDist:6,uih:1,atackDelay:5,speed:.8,xp:0,mat1:"fur",mat2:"paper",cantDropItems:!0,onInit:function(){Mb(this);this.sleep=!1;if(a)try{var b=E(this.tile.visibleTiles);J(b)&&!b.unit&&this.setTile(b)}catch(e){}},onAttack:function(a,e){this.bited=!0},onDamage:function(a,e,d,c){},onLogic:function(){if(this.bited)return this.delay=7,this.hp--,0>=this.hp&&(this.onDie(),this.hp=0),!0},onDie:function(){},onFire:function(a){}});D({name:"BeeBoss",imgId:114,
minLevel:-1,maxLevel:-1,hp:60,defence:10,power:8,lookDist:6,uih:0,atackDelay:40,speed:.5,xp:20,mat1:"meat",mat2:"paper",onInit:function(){Mb(this);wa(this,Z("skullKey"))},onAttack:function(a,e){},onDamage:function(a,e,d,c){},onDie:function(){},onFire:function(a){}});D({name:"Hive",boss:4,imgId:112,minLevel:-1,maxLevel:-1,hp:40,defence:5,power:0,lookDist:3,uih:-2,atackDelay:280,speed:0,xp:10,mat1:"wood",mat2:"aspen",cantDropItems:!0,onInit:function(){wa(this,Z("honeypotion"));this.beesCount=0;for(var a=
-32;32>=a;a+=16)for(var e=-32;32>=e;e+=16)try{yb(x.getTile(this.x+a,this.y+e))}catch(d){}lb()},onLogic:function(){130>this.beesCount&&(a=!0,ub(this,"Bee",1),a=!1,this.beesCount++);this.delay=this.type.atackDelay;return!0},onDamage:function(b,e,d,c){a=!0;ub(this,"Bee",2);a=!1},onDie:function(){this.lookDist=10;ka(Wa,1,this.tile,"BeeBoss")},onFire:function(a){}})})();"use strict";(function(){D({name:"Wolf",imgId:124,minLevel:21,maxLevel:24,hp:30,defence:14,power:10,lookDist:6,uih:-1,atackDelay:30,speed:.65,
xp:15,mat1:"grayFur",mat2:"garnet",onInit:function(){},onAttack:id,onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){}});D({name:"Viking",imgId:125,minLevel:23,maxLevel:24,hp:40,defence:21,power:14,lookDist:5,uih:-1,atackDelay:50,speed:.45,xp:20,mat1:"iron",mat2:"flesh",onInit:function(){},onAttack:function(a,b){},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){}});l({id:"thorsHammer",name:"Thors Hammer",equipType:"sword",imgId:123,onImgId:122,mat2:"gold",mat1:"iron",
onx:0,ony:6,minLevel:-1,maxLevel:-1,recalcStats:function(a,b){},onPickUp:function(){g.instance.damage(10);r.prompt(qa(this,m("ThorsHammerTake")));return!0},onInit:function(){this.update=function(){if(!c)return P.prototype.update.call(this)}},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){},onThrow:function(b){a&&(lb(),a=!1)}});var a,b=function(){d.power=Math.round(1.5*d.type.power);k.imgId=122;k.updateImg();ea(k);ia(k);c=!0},e=function(){d.power=d.type.power;k.imgId=123;k.updateImg();
ea(k);ia(k);c=!1},d,c,k,f,h,p=function(b,c){var e=x.getTile(b,c);e.wall&&(Wb(e.x,e.y),a=!0,x.explodeWall(e));e.unit&&e.unit!==d&&!vb(e.unit,"stun")&&(Db(e),e.unit.damage(7,k.sx,k.sy))};D({name:"Thor",imgId:121,boss:5,minLevel:-1,maxLevel:-1,hp:150,defence:17,power:19,lookDist:7,uih:-1,atackDelay:50,speed:.4,xp:15,mat1:"iron",mat2:"flesh",onInit:function(){d=this;h=f=0;k=Z("thorsHammer",this.tile);ia(k);b();var a=this.x;this.update=function(){k.flySteps&&!0!==k.flySteps&&(p(k.x+5,k.y+5),p(k.x+5,k.y+
11),p(k.x+11,k.y+5),p(k.x+11,k.y+11));c||this.tile!==k.tile||k.flySteps||(b(),f=15);this.x=a;var d=A.prototype.update.call(this);a=this.x;if(d)return d;0<h&&(h--,d=la&7,2===d?this.x+=1:5===d&&--this.x);c&&(k.reflect!==this.reflect&&(k.reflect=this.reflect,k.updateImg()),k.setTile(this.tile),k.visible=this.visible,k.x=this.x,k.x=this.reflect?k.x-3:k.x+3,k.y=this.y+A.walkPhases[this.walkPhase]+3,this.visible&&!this.sleep&&(this.reflect?M(this.x-3+6*Math.random(),this.y+6+7*Math.random(),tb,Bb):M(this.x+
14+6*Math.random(),this.y+6+7*Math.random(),tb,Bb)))}},onAttack:function(a,b){c&&!vb(a,"stun")&&(Db(a.tile,3),R(void 0,a,6))},onDamage:function(a,b,c,d){},onDie:function(){c&&(this.drop(k),e(),k.ys=-5,k.tile.units.reverse())},onFire:function(){},onLogic:function(){if(!this.sleep)if(0<f)0>=h&&f--;else if(c){var a=g.instance;if(!Ka()&&192>Math.abs(a.x-this.x)+Math.abs(a.y-this.y)){if(1>h)return h=80,this.delay=70,!0;ea(k);this.throwItemUnconditionally(k,a.x,a.y);e();f=8}}else{if(1>h)return h=80,this.delay=
42,!0;if(40>h&&!k.flySteps){ea(k);var a=this.x,b=this.y;this.x=k.x;this.y=k.y;this.throwItemUnconditionally(k,this.tile.x,this.tile.y);this.x=a;this.y=b;this.delay=40;return!0}}}})})();"use strict";(function(){D({name:"Druid",imgId:139,bullet:"magic",shootDist:6,minLevel:27,maxLevel:29,hp:40,defence:14,power:14,lookDist:7,uih:-1,atackDelay:190,speed:.6,xp:15,mat1:"wood",mat2:"cotton",onInit:function(){this.bullet="tpMagic"},onShoot:function(a){delete this.bullet},onAttack:function(a,b){},onDamage:function(a,
b,e,d){},onDie:function(){},onFire:function(){}});D({name:"Driada",imgId:140,bullet:"arrowPoisoned",shootDist:6,minLevel:26,maxLevel:29,hp:30,defence:14,power:9,lookDist:7,uih:-1,atackDelay:70,speed:.6,xp:10,mat1:"flesh",mat2:"squama",onInit:function(){},onShoot:function(a){},onAttack:function(a,b){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(a){}});D({name:"Ent",imgId:144,minLevel:27,maxLevel:29,hp:80,defence:13,power:24,fireDamageMultiplier:8,lookDist:1,uih:-1,atackDelay:230,
speed:.5,lockedTile:!0,xp:18,mat1:"wood",mat2:"stem",onInit:function(){},onAttack:function(a,b){X(a,"rooting",4)},onDamage:function(a,b,e,d){},onLogic:function(){},onDie:function(){},onFire:function(){}});D({name:"BlindGuardian",imgId:127,boss:6,minLevel:-1,maxLevel:-1,hp:70,defence:25,power:50,lookDist:1,uih:-1,atackDelay:200,speed:.3,xp:35,mat1:"flesh",mat2:"iron",onInit:function(){this.sayPhase=0},onAttack:function(a,b){g.surprise("blindGuard");Db(a.tile,3)},onDamage:function(a,b,e,d){},onDie:function(){},
onFire:function(){},onLogic:function(){!this.sleep&&.66<Math.random()&&(this.sayPhase++,.5<Math.random()&&this.sayPhase++,this.sayPhase%=3,this.say(m("blindSay"+this.sayPhase),"#bb9"))}})})();"use strict";var Mb;(function(){Mb=function(b){b.phaseX=Math.random()*za;b.phaseY=Math.random()*za;b.phaseXs=.2*Math.random()-.1;b.phaseYs=.1*Math.random()-.05;b.draw=a;b.isFly=!0};var a=function(){this.phaseX+=this.phaseXs;this.phaseX>za&&(this.phaseX-=za);this.phaseY+=this.phaseYs;this.phaseY>za&&(this.phaseY-=
za);var a=this.x,b=this.y;0<this.hp&&(this.x+=4*Math.cos(this.phaseX),this.y+=2*Math.cos(this.phaseY),this.y-=2);A.prototype.draw.call(this);this.x=a;this.y=b};D({name:"Flyhead",imgId:147,minLevel:31,maxLevel:34,hp:40,defence:14,power:21,lookDist:6,uih:-1,atackDelay:30,speed:.75,xp:20,mat1:"bone",mat2:"stem",onInit:function(){Mb(this)},onAttack:function(a,b){},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(){}});D({name:"Ghost",amount:4,imgId:149,minLevel:32,maxLevel:34,hp:60,defence:45,
power:40,lookDist:7,uih:-1,atackDelay:60,speed:.45,xp:45,mat1:"fur",mat2:"meat",onInit:function(){},onAttack:function(a,b){X(this,"regeneration",b)},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(a){}});var b;l({id:"scragsEgg",name:"Egg",imgId:133,minLevel:-1,maxLevel:-1,mat1:"bone",mat2:"bone",recalcStats:function(a,b){},onPickUp:function(){b.type.eggTaked.call(b)},onInit:function(){},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(){},onThrow:function(a){ma(a,"needle");
for(var b=15;0<b;){var c=M(a.x+8,a.y+8,Ia,Ua);c.xs=-2+4*Math.random();c.ys=-2+4*Math.random();b--}return!0}});l({name:"Needle",id:"needle",equipType:"sword",imgId:134,onImgId:135,onx:-2,ony:0,mat1:"silver",mat2:"silver",minLevel:-1,maxLevel:-1,recalcStats:function(a,b){a.power+=1},onInit:function(){},onAttack:function(a,b){a.type&&"Scrag"===a.type.name&&a.type.onNeedle.call(a)},onDamage:function(a,b,d,e){},onDie:function(){},onFire:function(){}});var e,d=function(){this.x=e;var a=A.prototype.update.call(this);
e=this.x;if(a)return a;this.needled&&30<this.hp&&(this.damage(1),a=la&7,2===a?this.x+=1:5===a&&--this.x)};D({name:"Scrag",imgId:131,boss:7,minLevel:-1,maxLevel:-1,hp:320,defence:170,power:30,lookDist:5,uih:-1,atackDelay:60,speed:.6,xp:45,mat1:"bone",mat2:"gold",onInit:function(){ma(this.tile,"scragsEgg");this.update=d;b=this},onAttack:function(a,b){},onDamage:function(a,b,d,e){},eggTaked:function(){132!==this.imgId&&(this.imgId=132,this.updateImg())},onNeedle:function(){this.needled||(this.needled=
!0,R(this.tile,this,20),this.delay=300,this.say("SCRAGS_SCEAM","#fa9"),this.power=0,this.speed=.2)},onDie:function(){O(new Na(this,Cc))},onFire:function(){},onLogic:function(){}})})();"use strict";(function(){var a=function(){this.phaseX+=.1;this.phaseX>za&&(this.phaseX-=za);var a=this.x,b=this.y;this.x=a+3*Math.cos(this.phaseX);this.y=b+3*Math.sin(this.phaseX);B.prototype.draw.call(this);this.x=a+3*Math.cos(this.phaseX+Eb);this.y=b+3*Math.sin(this.phaseX+Eb);B.prototype.draw.call(this);this.x=a+
3*Math.cos(this.phaseX-Eb);this.y=b+3*Math.sin(this.phaseX-Eb);B.prototype.draw.call(this);this.x=a;this.y=b},b=function(){this.tile&&this.setTile(null);this.phase?(this.x-=.5,5>this.x&&(this.phase=!1)):(this.x+=.5,this.x>16*Za-21&&(this.phase=!0));ic&&(this.phase=!this.phase);this.visible=x.getTile(this.x+8,this.y+8).explored;this.delay?this.delay--:8>Math.abs(g.instance.x-this.x)&&8>Math.abs(g.instance.y-this.y)&&(this.delay=60,g.instance.damage(this.type.power,this.phase?-10:10,0,this),jc(3))};
D({name:"Trap",imgId:141,minLevel:36,maxLevel:39,hp:40,defence:14,power:20,lookDist:6,uih:-1,atackDelay:30,speed:.2,xp:15,mat1:"rustyIron",mat2:"garnet",chance:.3,cantDropItems:!0,onInit:function(){this.draw=a;this.isFly=!0;this.phaseX=Math.random()*za;this.update=b;this.phase=50<u(100);this.y+=1},onAttack:function(a,b){},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){}});D({name:"GiantRat",imgId:148,minLevel:36,maxLevel:39,hp:60,defence:24,power:26,lookDist:7,uih:-1,atackDelay:60,
speed:.35,xp:25,mat1:"fur",mat2:"flesh",onInit:function(){},onAttack:Ub(100,8),onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(a){}});var e=function(){0<this.visLevel&&(this.visLevel-=.01);var a=Math.round(this.visLevel);a!==this.prevVisLevel&&(this.prevVisLevel=a,0<a?(this.invisible=!1,this.mat1=d[Math.max(0,Math.min(2,a-3))],this.mat2=d[Math.max(0,Math.min(2,a))],this.updateImg()):this.invisible=!0);return A.prototype.update.call(this)},d;D({name:"Invisible",imgId:61,minLevel:37,
maxLevel:39,hp:80,defence:21,power:19,lookDist:6,uih:-1,atackDelay:50,speed:.35,xp:24,mat1:"invisibility",mat2:"invisibility",onInit:function(){d||(d=[f.mat("broken"),f.mat("invisibility"),f.mat("bone")]);this.invisible=!0;this.prevVisLevel=this.visLevel=0;this.update=e},onAttack:function(a,b){},onDamage:function(a,b,c,d){this.visLevel+=1},onDie:function(){},onFire:function(){}});l({name:"ratsHearth",id:"ratsHearth",imgId:137,mat1:"meat",mat2:"flesh",minLevel:-1,maxLevel:-1,recalcStats:function(a,
b){},onInit:function(){},onAttack:function(a,b){},onDamage:function(a,b,c,d){},onDie:function(){},onFire:function(){},actions:[{name:"Eat",action:function(a){O(new da(a));ka(function(){Pa=0;fb=10;oa=1;gb=2;sb=1;Qa=15;xa+=5;g.setTransform({disableSlots:"sword shield armor pants boots amulet helmet".split(" "),ringsLimit:1,capacityLimit:0,cantCareGold:!0,imgId:36,mat1:"fur",mat2:"flesh",heroPic:"data/ratHero.png",uih:6,lookDist:10,canPassLockedDoor:!0,abilities:["ratsInvisibility"]});g.instance.hp=
Math.min(g.instance.hp,Qa);g.instance.say(m("pi pi pipi"),"#f80")},500);return!0}}]});var c,k,h=function(){this.x=c;var a=A.prototype.update.call(this);c=this.x;if(a)return a;if(!this.sleep)switch(k++,1023<k&&(k=0),470<(k&511)&&(a=la&7,2===a?this.x+=1:5===a&&--this.x),k){case 500:case 1012:O(new da(this));break;case 511:this.imgId=138;this.power=15;this.defence=20;this.mat1=f.mat("flesh");this.speed=.9;this.updateImg();break;case 1023:this.imgId=this.type.imgId,this.power=this.type.power,this.mat1=
f.mat(this.type.mat1),this.defence=this.type.defence,this.speed=this.type.speed,this.updateImg()}};D({name:"RatMutant",imgId:136,boss:8,minLevel:-1,maxLevel:-1,hp:200,defence:70,power:40,lookDist:6,uih:-2,atackDelay:30,speed:.7,xp:50,mat1:"fur",mat2:"meat",cantDropItems:!0,onInit:function(){this.sleep=!0;this.update=h;c=this.x;k=0},onAttack:function(a,b){},onDamage:function(a,b,c,d){},onDie:function(){ma(this.tile,"ratsHearth")},onFire:function(){},onLogic:function(){if(511<k&&850>k)return $c.call(this),
!0}})})();"use strict";(function(){l({name:"anotherRatsHearth",id:"anotherRatsHearth",imgId:137,mat1:"meat",mat2:"flesh",minLevel:-1,maxLevel:-1,recalcStats:function(a,b){},onInit:function(){},onAttack:function(a,b){},onDamage:function(a,b,e,d){},onDie:function(){},onFire:function(){},actions:[{name:"Eat",action:function(a){O(new da(g.instance));ka(function(){g.setTransform({disableSlots:"sword shield armor pants boots amulet helmet".split(" "),cantCareGold:!0,imgId:138,mat1:"flesh",mat2:"fur",uih:6,
lookDist:8,abilities:["ratsInvisibility"]});g.instance.hp=Math.min(g.instance.hp,Qa)},500);ka(function(){O(new da(g.instance))},8E3);ka(function(){xa-=5;g.setTransform(null);g.instance.say(m("OMGitsme"),"#f80");g.surprise("humAgain")},8500);return!0}}]});D({name:"RatKing",imgId:150,boss:9,minLevel:-1,maxLevel:-1,hp:100,defence:4,power:4,lookDist:6,uih:-2,atackDelay:30,speed:.7,xp:100,mat1:"grayFur",mat2:"gold",onInit:function(){for(var a=0;60>a;a++){var b=Fa(I);b&&ma(b)}},onAttack:function(a,b){},
onDamage:function(a,b,e,d){},onDie:function(){ma(this.tile,"anotherRatsHearth")},onFire:function(){},onLogic:function(){}})})();"use strict";var $a;(function(){$a=function(a,b){B.call(this,a);this.img=b};$a.prototype=new B;$a.prototype.constructor=$a;$a.prototype.draw=function(){p.drawImage(this.img,(this.x+y)*h,(this.y+w)*h,this.img.width*h,this.img.height*h)}})();"use strict";var Hb,ad,r,C=window.React.DOM.span,q=window.React.DOM.div,ta=window.React.DOM.br,pb=window.React.DOM.img,Q,G,ob;(function(){function a(a,
b,c){b&&b.unit&&b.unit.team!==c&&a.push(b.unit)}function b(a,b,c){if(g.isSlotDisabled(b?a+b:a))return"slot_locked";b=c.getEquipedOfType(a)[b];return b?b:(b=f.mat("emptyslot"),{imgId:p[a],mat1:b,mat2:b})}var e=["hp","power","defence","speed","lookDistSelfOnly"],d={position:"relative",display:"inline-block",margin:20,background:"#123",border:"10px double #456",cursor:"auto"},c={padding:"5px 12px",margin:5,display:"inline-block",border:"3px solid #456"},k={padding:"5px 12px",margin:5,display:"inline-block",
border:"3px solid #234",color:"#345"};G=function(a,b,d){return C({key:d,style:b?c:k,className:b?"clickable":void 0,onClick:b},a)};ob=function(a,b,c,d,e){return C({title:e,style:{padding:4,margin:5,display:"inline-block",border:"3px solid #456"},className:d?"clickable":void 0,onClick:d?function(a){d(a);V(a)}:void 0},sc({imgId:a,mat1:b,mat2:c}))};var h=function(a){if(a=a.getGrade())return 0<a?C({style:{position:"absolute",pointerEvents:"none",left:2,top:-2,color:"#0d0"}},"+"+a):C({style:{position:"absolute",
pointerEvents:"none",left:2,top:-2,color:"#f00"}},a)};Q=function(a,b,c,d,e){if("slot_locked"!==c){var g={display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"middle",width:72,height:72,background:"#012",margin:4,padding:4},f;for(f in a)a.hasOwnProperty(f)&&(g[f]=a[f]);var k,v,m;c&&c.constructor===P?(v=h(c),a=r.state.itemChoosingValidator?!r.state.itemChoosingValidator(c):!c.canEquipByLevel(),r.state.magicAnimatedItem===c&&(delete r.state.magicAnimatedItem,m=q({style:{position:"absolute",
top:"33.33%",left:"33.33%",width:"33.33%",height:"33.33%"},className:"magic-animation"},q({style:{background:"#fff",position:"absolute",width:"100%",height:"100%",left:"-150%"}}),q({style:{background:"#fff",position:"absolute",width:"100%",height:"100%",right:"-150%"}}))),k=pb({src:Nb(c.imgId,c.mat1,c.mat2),title:c.getName(),onClick:function(){e?e(c):r.clickItem(c)},style:{cursor:r.state.itemChoosingValidator&&a?void 0:"pointer",background:"rgba(0,0,0,0.01)",display:"block",width:"100%",height:"100%",
outline:a?"4px solid #600":void 0}})):c&&(k=pb({src:Nb(c.imgId,c.mat1,c.mat2),style:{display:"block",width:"100%",height:"100%"}}));d=1<d?C({style:{position:"absolute",pointerEvents:"none",right:2,bottom:-2}},d):void 0;return C({key:b,style:g},k,d,v,m)}};var l;ad=React.createClass({displayName:"ui-modal",getInitialState:function(){return{}},componentDidMount:function(){l=this},close:function(){this.state.content?this.setState({content:!1,opened:this.state.item}):this.replaceState({})},showItem:function(a,
b){this.setState({opened:!0,item:a,notDiscardable:!1,customActions:b})},show:function(a,b){this.setState({opened:!0,content:a,notDiscardable:b})},unequip:function(){r.unequip(this.state.item);this.close()},equip:function(){r.equip(this.state.item);this.close()},drop:function(){r.drop(this.state.item);this.close()},pickup:function(){g.instance.pickupItem(this.state.item);this.close();r.refreshActions()},setSlot1:function(){r.exchangeSlots(0,this.state.item.slot);this.close()},setSlot2:function(){r.exchangeSlots(1,
this.state.item.slot);this.close()},throwItem:function(){r.throwItem(this.state.item);this.close()},render:function(){if(this.state.opened){var a;if(this.state.content)a=this.state.content;else{var b=this.state.item,c;Ka()||(this.state.customActions?c=this.state.customActions:(c=[],b.type.actions&&b.type.actions.some(function(a){c.push(G(m(a.name),function(){r.close(!0);b.callAction(a)}.bind(this),a.name))}.bind(this)),b.canEquip()&&(g.instance.isEquiped(b)?g.instance.hasEmptySlot(b)&&(a=b.canEquipByLevel()?
m("Unequip"):C({style:{color:"#b66"}},m("Unequip")+"!!!"),c.push(G(a,this.unequip,"uneq"))):b.canEquipByLevel()?c.push(G(m("Equip"),this.equip,"eq")):c.push(C({key:"noEquip",style:{background:"#012",marginRight:8,color:"#345",display:"inline-block",verticalAlign:"middle",fontSize:"70%",padding:5}},m("Too heavy"),ta(),m("for you")))),g.instance.hasItem(this.state.item)?(c.push(G(m("Drop"),this.drop,"drop")),c.push(G(m("Throw"),this.throwItem,"throw")),c.push(q({key:"fasts",style:{fontSize:"60%",marginTop:20,
opacity:"0.5"}},m("set fast slot:"),C({title:"Set fast slot 1"},G("1",this.setSlot1)),C({title:"Set fast slot 2"},G("2",this.setSlot2))))):(g.instance.hasEmptySlot(this.state.item)&&c.push(G(m("PickUp"),this.pickup,"pickup")),c.push(G(m("Throw"),this.throwItem,"throw")))));a=q(null,C({style:{position:"relative",display:"inline-block"}},ob(b.imgId,b.mat1,b.mat2),h(b)),b.descItem(),q({style:{marginTop:20}},c),q({style:{position:"absolute",zIndex:2,right:-25,top:-25}},G("\u00d7",this.close)))}return q({className:"scrollable-layer",
onClick:this.state.notDiscardable?void 0:this.close,style:{cursor:"pointer",zIndex:4,background:"rgba(0,10,20,0.8)",textAlign:"center"}},q({onClick:V,style:{cursor:"auto",display:"inline-block",position:"relative",maxWidth:600,marginTop:40,background:"#123",border:"3px solid #456",padding:30}},a))}return C()}});var p={sword:8,helmet:54,amulet:19,armor:46,pants:53,boots:50,shield:83,ring:2},u=React.createClass({displayName:"ui-speed-controll",getInitialState:function(){return{curVal:this.props.getter()}},
setVal:function(a){this.setState({curVal:a});this.props.setter(a)},isCurrentVal:function(a){return a===this.state.curVal},render:function(){for(var a=[],b=-3;4>b;b++){var c=this.isCurrentVal(b);(function(){var d=b;a.push(G(c?"\u2022":"\u00b7",c?void 0:function(){this.setVal(d)}.bind(this),b+"-"+c))}).call(this)}return q({style:{margin:30}},q(null,this.props.title),a,q({style:{fontSize:"70%",color:"#345"}},q({style:{"float":"left"}},m("slower")),q({style:{"float":"right"}},m("faster"))))}}),w,t=function(a){a.type.bad?
w.push(q({key:a.type.name,style:{color:"#a00"}},m(a.type.name))):w.push(q({key:a.type.name,style:{color:"#0a0"}},m(a.type.name)))},Y=function(){try{if(window.self!==window.top)return!0}catch(v){return!0}return"pixel-cave.com"!==document.location.host},U=function(){return React.DOM.a({href:"http://pixel-cave.com",target:"_blank",style:{fontSize:"60%",pointerEvents:"all",cursor:"pointer",color:"#555"}},"www.pixel-cave.com")},y=React.createClass({displayName:"ui-blinker",componentDidMount:function(){this.timer=
setInterval(this.blink,100);this.setState({phase:0})},componentWillUnmount:function(){clearInterval(this.timer)},blink:function(){this.setState({phase:this.state.phase+1})},render:function(){return this.state&&this.state.phase&&(6<this.state.phase&&this.state.phase&1||13<this.state.phase)?this.props.after:this.props.before}}),A="",D=function(a){A=a.target.value};Hb=React.createClass({displayName:"ui-class",componentDidMount:function(){r=this},refreshActions:function(){g.instance.tile&&this.setState({player:g.instance})},
getInitialState:function(){return{}},close:function(a){!a&&l.state.opened?l.close():(l.close(),this.replaceState({}))},open:function(a,b,c,d){this.setState({opened:!0,customUi:d,tab:Ka()?"menu":void 0})},toggle:function(){this.state.opened||this.state.tileChoosing?this.close():this.open()},transitBlinking:function(a,b){return React.createElement(y,{before:a,after:b})},prompt:function(a,b,c,d,e,g){b||(b=m("Ok"));var f;d&&(f=G(d,function(){l.close();e&&e()}.bind(this)));l.show(q(null,q({style:{marginBottom:20}},
a),G(b,function(){l.close();c&&c()}.bind(this)),f),g)},newGame:function(){var a=function(){Qc();this.close(!0)}.bind(this);0<g.instance.inventory.length&&0>=g.instance.hp?(r.close(),r.chooseItem(m("chooseInherit"),function(b){z("inheritItem",b.serialize());a()},function(){return!0})):a()},clickItem:function(a,b){if(this.state.itemChoosing){if(!this.state.itemChoosingValidator||this.state.itemChoosingValidator(a))this.state.itemChoosingCallback(a),this.setState({itemChoosing:void 0,itemChoosingCallback:void 0,
itemChoosingValidator:void 0})}else l.showItem(a,b)},pickupItem:function(a){g.instance.pickupItem(a);this.refreshActions()},equip:function(a){g.instance.equip(a);this.refreshActions()},unequip:function(a){g.instance.unequip(a);this.refreshActions()},attackEnemy:function(a){g.instance.attackEnemy(a)},isPauseNeed:function(){return this.state.opened||l.state.opened},throwItem:function(a){this.chooseTile(m("CHOOSE_TO_THROW")+" "+a.getName(),function(b,c){return g.instance.hasItem(a)||g.instance.x===a.x&&
g.instance.y===a.y?g.instance.throwItem(a,b,c):!0}.bind(this))},onMapClick:function(a,b){if(this.state.tileChoosing)return this.state.tileChoosingCallback(a,b)&&this.close(),!0},chooseTile:function(a,b){this.setState({opened:!1,tileChoosing:a,tileChoosingCallback:b})},chooseItem:function(a,b,c){this.setState({opened:!0,tab:"",itemChoosing:a,itemChoosingCallback:b,itemChoosingValidator:c})},drop:function(a){g.instance.drop(a);this.refreshActions()},enumBufs:function(a){w=a;Ib(g.instance).some(t)},
useSlot1:function(){this.fastUseItem(g.instance.getItemAtSlot(0))},useSlot2:function(){this.fastUseItem(g.instance.getItemAtSlot(1))},fastUseItem:function(a){a&&!Ka()&&(a.type.actions&&!a.type.actions[0].noFastShortcut?a.callAction(a.type.actions[0]):a.type.equipType&&a.canEquipByLevel()?this.equip(a):this.throwItem(a))},exchangeSlots:function(a,b){g.instance.inventory.some(function(c){c.slot===a?c.slot=b:c.slot===b&&(c.slot=a)});this.refreshActions()},migicAnimateItem:function(a){this.setState({magicAnimatedItem:a})},
renderEnemyIcon:function(a,b){return C({key:b+a.type.name,title:a.type.name},ob(a.imgId,a.mat1,a.mat2,function(){this.attackEnemy(a)}.bind(this)))},renderItemIcon:function(a,b){return C({key:b+a.type.name,title:a.getName()},ob(a.imgId,a.mat1,a.mat2,function(){this.pickupItem(a)}.bind(this)))},toggleFullscreen:function(){this.forceUpdate();tc()},render:function(){var c=g.instance;if(Yb()||!c)return C();if(this.state.opened){var f;if(this.state.customUi)c=this.state.customUi;else{switch(this.state.tab){case "report":c=
q({onClick:V},React.DOM.textarea({onClick:V,onChange:D,defaultValue:A,onKeyDown:function(a){a.stopPropagation()},placeholder:m("submit_desc"),ref:"reportArea",style:{display:"block",padding:7,border:"3px solid #456",height:200,width:"80%",margin:"13px auto",background:"#012",color:"#def"}}),G(m("SUBMIT"),function(){var a={version:uc,desc:this.refs.reportArea.value,data:JSON.stringify(Jc())};window.occuredErrorsInGame&&(a.errors=window.occuredErrorsInGame.join("\n"));$.post("https://pixel-cave.com/reports/",
a,function(a){a||(a=m("tanksForReport"));r.prompt(a,"ok",function(){this.close(!0)}.bind(this));A=""}.bind(this))}.bind(this)));break;case "menu":var k;k=fa<Ha?G(m("Replay level").replace("%",fa+"/"+Ha),function(){this.close();hb=!0}.bind(this)):q(null,m("LATEST_ATTEMPT"));c=q(null,React.createElement(u,{getter:function(){return Ob},setter:function(a){Ob=a;z("gameSpeed",a)},title:m("Game Speed")}),React.createElement(u,{getter:function(){return Pb},setter:function(a){Pb=a;z("battleSpeed",a)},title:m("Battle Speed")}),
q({style:{margin:20}},q(null,m("Language")),lc.map(function(a){var b=q(null,pb({style:{width:"48px",textAlign:"center"},src:"data/locales/"+a.id+".png"}),ta(),a.name);return Xc===a.id?C({style:{display:"inline-block",verticalAlign:"middle",background:"#012",padding:"5px 12px",margin:8},key:a.id},b):G(b,function(){kc(a.id,function(){this.forceUpdate()}.bind(this))}.bind(this),a.id)}.bind(this))),q({style:{margin:20}},m("Fullscreen"),G(H("fullscreen")?m("off"):m("on"),this.toggleFullscreen)),q({style:{margin:10}},
G(m("New game"),function(){Ka()?this.newGame():r.prompt(m("New Game Prompt"),m("Yes"),this.newGame,m("No"))}.bind(this)),React.DOM.br(),k));break;default:for(var h=[],l=g.getCapacity(),n=0;n<l;n++){var p=c.getItemAtSlot(n);k="";p&&(k=p.mat1.key+"_"+p.mat2.key+"_"+p.imgId);h.push(Q({},k+"_"+n,p,c.getItemsCountAtSlot(n)))}if(c.tile){var w=!1;c.tile.units.some(function(a,b){a.constructor===P&&a.type&&!a.type.notDisplayInInventory&&(w||(h.push(q({key:"ground",style:{margin:10,fontSize:"60%",color:"#567"}},
m("onGround:"))),w=!0),h.push(Q({},a.mat1.key+"_"+a.mat2.key+"_"+a.imgId+"_ground_"+b,a,1)))})}var t;this.state.itemChoosing&&(t=q({style:{fontSize:"120%",textAlign:"center",background:"#012",paddingTop:20,paddingBottom:20,top:0,pointerEvents:"none",width:"100%",zIndex:2,position:"absolute"}},this.state.itemChoosing));l=e.map(function(a,b){return q({key:a+g.instance[a],style:{marginBottom:10}},m(a)+": "+("hp"===a?g.instance.hp+"/"+g.instance.maxHp:"speed"===a?g.instance[a].toFixed(1):g.instance[a]))});
l.unshift(q({key:"lvl",style:{marginBottom:10}},m("Level")+": "+oa));l.push(q({key:"exp",style:{marginBottom:10}},m("Expirience")+": "+Pa+"/"+fb));l.push(q({key:"floor",style:{marginTop:20,fontSize:"120%",color:"#486"}},x.getLevelName()));0<ha&&l.push(q({key:"money",style:{marginTop:20,fontSize:"90%",color:"#fe0"}},m("money")+": "+va(ha)));this.enumBufs(l);c=q(null,t,q({style:{margin:10,maxWidth:420,display:"inline-block",verticalAlign:"top",overflowX:"auto",overflowY:"auto"}},h),q({style:{margin:10,
width:436,height:450,position:"relative",display:"inline-block",verticalAlign:"top",overflowX:"auto",overflowY:"auto"}},pb({src:Hb.heroPic,style:{width:256,height:352,position:"absolute",top:98,left:90}}),Q({position:"absolute",border:"1px solid #456",left:0,top:20},"sword",b("sword",0,c)),Q({position:"absolute",border:"1px solid #456",left:140,top:0},"helmet",b("helmet",0,c)),Q({position:"absolute",border:"1px solid #456",right:140,top:0},"amulet",b("amulet",0,c)),Q({position:"absolute",border:"1px solid #456",
left:0,bottom:0},"armor",b("armor",0,c)),Q({position:"absolute",border:"1px solid #456",right:0,bottom:80},"pants",b("pants",0,c)),Q({position:"absolute",border:"1px solid #456",right:0,bottom:0},"boots",b("boots",0,c)),Q({position:"absolute",border:"1px solid #456",right:0,top:20},"shield",b("shield",0,c)),Q({position:"absolute",border:"1px solid #456",right:0,bottom:170},"ring1",b("ring",3,c)),Q({position:"absolute",border:"1px solid #456",right:0,bottom:250},"ring2",b("ring",2,c)),Q({position:"absolute",
border:"1px solid #456",left:0,bottom:170},"ring3",b("ring",1,c)),Q({position:"absolute",border:"1px solid #456",left:0,bottom:250},"ring4",b("ring",0,c)),q({style:{position:"absolute",color:"#456",left:100,right:100,top:105}},l)))}f=q({style:{margin:10,textAlign:"center",borderBottom:"3px solid #234"}},G(m("Inventory"),this.state.tab?function(){this.setState({tab:""})}.bind(this):void 0),G(m("Menu"),"menu"===this.state.tab?void 0:function(){this.setState({tab:"menu"})}.bind(this)),G(m("Report Error"),
"report"===this.state.tab?void 0:function(){this.setState({tab:"report"})}.bind(this)))}var y;Y()&&(y=q({style:{textAlign:"center",marginBottom:8},onClick:function(a){a.stopPropagation()}},U()));return q({className:"scrollable-layer",onMouseUp:V,onClick:this.close,style:{cursor:"pointer",minHeight:"100%",background:"rgba(0,10,20,0.8)",textAlign:"center"}},q({style:d,onClick:V},f,c,y,q({style:{margin:10,position:"absolute",zIndex:2,right:-30,top:-30}},G("\u00d7",this.close)),q({style:{width:20,height:20,
border:"3px solid #456",background:"#123",position:"absolute",zIndex:2,right:-12,bottom:-12}}),q({style:{width:20,height:20,border:"3px solid #456",background:"#123",position:"absolute",zIndex:2,left:-12,bottom:-12}}),q({style:{width:20,height:20,border:"3px solid #456",background:"#123",position:"absolute",zIndex:2,left:-12,top:-12}})))}if(this.state.tileChoosing)return q({style:{position:"absolute",pointerEvents:"none",bottom:70,left:0,right:0,textAlign:"center"}},C({onMouseUp:V,style:{display:"inline-block",
background:"rgba(0,0,0,0.8)",padding:8}},this.state.tileChoosing,G("\u00d7",this.close)));if(t=c.tile){f=c.team;n=t.enumItems();if(n.length){var B;5<n.length&&(B=". . .",n.length=5);n=C({style:{display:"inline-block",marginRight:20}},n.map(this.renderItemIcon),B)}else n=void 0;l=[];a(l,t.up,f);a(l,t.right,f);a(l,t.down,f);a(l,t.left,f);l=l.length?C({style:{display:"inline-block",background:"#400",border:"3px solid #600",padding:"3",marginRight:20,marginTop:-9,marginBottom:-9}},l.map(this.renderEnemyIcon)):
void 0}t=c.getItemAtSlot(0);B=c.getItemAtSlot(1);var Mc,E;t&&(Mc=Q({pointerEvents:"none"},void 0,t,c.getItemsCountAtSlot(0)));B&&(E=Q({pointerEvents:"none"},void 0,B,c.getItemsCountAtSlot(1)));var F;F=[];c=g.getCapacity();0<c&&(F.push(C({key:F.length,style:{cursor:"pointer",background:"#123",display:"inline-block",width:80,height:80},title:t?t.getName()+' "1"':'fast slot "1"',onClick:this.useSlot1},Mc)),1<c&&(F.push(ta({key:F.length})),F.push(C({key:F.length,style:{cursor:"pointer",background:"#123",
marginTop:16,display:"inline-block",width:80,height:80},title:B?B.getName()+' "1"':'fast slot "2"',onClick:this.useSlot2},E))));g.transform&&g.transform.abilities&&g.transform.abilities.some(function(a){a=Fb[a];F.push(ta({key:F.length}));var b=a.isEnabled.call(a);F.push(C({key:F.length,style:{cursor:b?"pointer":void 0,opacity:b?1:.5,background:"#123",marginTop:16,display:"inline-block",width:80,height:80},title:m(a.name),onClick:function(){b&&(a.onClick.call(a),a.usedOnLevelCount++,r.refreshActions())}},
Q(void 0,void 0,a,1)))});0<F.length&&(p=q({style:{textAlign:"right",position:"absolute",transform:"scale(0.5)",bottom:0,right:0}},F));Y()&&(y=q({style:{position:"absolute",textAlign:"center",pointerEvents:"none",left:0,right:0,bottom:10}},U()));c=[];this.enumBufs(c);c=c.length?q({style:{textAlign:"right",padding:10,fontSize:"70%"}},c):void 0;Ka()&&(k=fa<Ha?G(m("Replay level").replace("%",fa+"/"+Ha),function(){this.close();hb=!0}.bind(this)):G(m("New game"),this.newGame),k=q({style:{position:"absolute",
pointerEvents:"none",bottom:70,left:0,right:0,textAlign:"center"}},C({onMouseUp:V,style:{display:"inline-block",background:"rgba(0,0,0,0.8)",padding:8}},k)));return q({onMouseUp:V},React.DOM.div({style:{position:"absolute",right:5,top:5,textAlign:"right"}},l,n,ob(39,"fur","iron",this.open,'Inventory ("i" or "Esc")'),c),p,y,k)}})})();"use strict";var sc,qa,Nb;(function(){sc=function(b){return React.createElement(a,b)};qa=function(a,e){return q({style:{textAlign:"center"}},C({style:{display:"inline-block",
marginBottom:15}},sc(a)),ta(),e)};Nb=function(a,e,d){return f.img(a,e,d).toDataURL()};var a=React.createClass({displayName:"icon",getInitialState:function(){return this.refreshIcon(this.props)},componentWillReceiveProps:function(a){a.imgId===this.props.imgId&&a.mat1===this.props.mat1&&a.mat2===this.props.mat2||this.setState(this.refreshIcon(a))},refreshIcon:function(a){return{imUrl:Nb(a.imgId,f.mat(a.mat1.key||a.mat1),f.mat(a.mat2.key||a.mat2))}},render:function(){return pb({src:this.state.imUrl,
style:{display:"block",width:48,height:48}})}})})();"use strict";var tc;(function(){function a(a,b){if(!Ja()&&!r.onMapClick(a,b))try{x.onClick(a,b),H("fullscreen")!==d&&e()}catch(od){}}function b(a,b,c){a=Math.max(Lb,Math.min(12,a));if(h!=a){var d=jb(b),e=kb(c);h=a;y-=d-jb(b);w-=e-kb(c);z("scale",h)}}var e,d=!1;try{var c=function(a){d=!d};document.addEventListener("webkitfullscreenchange",c);document.addEventListener("mozfullscreenchange",c);document.addEventListener("fullscreenchange",c);e=function(){H("fullscreen")?
document.documentElement.requestFullScreen?document.documentElement.requestFullScreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullScreen&&document.documentElement.webkitRequestFullScreen():document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()};tc=function(){var a=!H("fullscreen");
z("fullscreen",a);e()}}catch(U){e=tc=function(){}}var g,f,l=function(a){for(var b=0,c=0,d=0;d<a.length;d++)var e=a[d],b=b+e.pageX,c=c+e.pageY;b/=a.length;c/=a.length;b={x:b,y:c};2===a.length&&(c=a[0].pageX-a[1].pageX,a=a[0].pageY-a[1].pageY,b.s=Math.sqrt(c*c+a*a));return b},c=document;c.addEventListener("touchstart",function(a){m=!0;f=g=l(a.touches)});c.addEventListener("touchend",function(b){if(1===b.changedTouches.length&&"mapCanvas"===b.target.id){var c=l(b.changedTouches);40>Math.abs(f.x-c.x)&&
40>Math.abs(f.y-c.y)&&a(jb(c.x),kb(c.y));g=l(b.touches)}});c.addEventListener("touchmove",function(a){var c=l(a.touches);if(Ja()){a=g.x-c.x;var d=g.y-c.y,e=document.getElementsByClassName("scrollable-layer"),f=e.length-1;e[f].scrollLeft+=a;e[f].scrollTop+=d}else"mapCanvas"===a.target.id&&(V(a),a=c.y-g.y,y+=(c.x-g.x)/h,w+=a/h,c.s&&g.s&&b(c.s/g.s*h,c.x,c.y));g=c});var m,p,q;window.addEventListener("mousedown",function(a){m||(p=a.pageX,q=a.pageY)});window.addEventListener("mouseup",function(b){if(!m&&
30>Math.abs(p-b.pageX)&&30>Math.abs(q-b.pageY)){var c=jb(b.pageX);b=kb(b.pageY);a(c,b)}});var t,u;window.addEventListener("mousemove",function(a){if(!m&&!Ja())if(1===a.buttons){if("mapCanvas"===a.target.id&&(V(a),void 0!==t)){var b=a.pageY-u;y+=(a.pageX-t)/h;w+=b/h}t=a.pageX;u=a.pageY}else t=void 0});c=function(a){if(!m&&!Ja()){var c=h;a.wheelDelta&&0<a.wheelDelta||0>a.detail?c++:c--;V(a);a.pageX&&b(c,a.pageX,a.pageY)}};try{window.addEventListener("mousewheel",c)}catch(U){}try{window.addEventListener("DOMMouseScroll",
c)}catch(U){}})();"use strict";var X,Wc,Tc,Ib,Pc,Nc,vb;(function(){var a,b=function(){this.unit.addSkinMat&&this.unit.addSkinMat("poisonedFlesh")},e=function(){this.unit.removeSkinMat&&this.unit.removeSkinMat("poisonedFlesh")},d={regeneration:{name:"Regeneration",update:function(){if(ec)return this.pow--,this.unit.hp<this.unit.maxHp&&this.unit.hp++,this.unit.say("+","#0a0"),1>this.pow}},speedup:{name:"Accelerated",init:function(){this.unit.recalcStats||(this.unit.speed+=1)},onRemove:function(){this.unit.recalcStats||
--this.unit.speed},recalcStats:function(a){0<this.pow&&(a.speed+=1)},update:function(){if(xb)return this.pow--,0>=this.pow}},madness:{name:"Mad",init:function(){this.unit.say(m("Mad"),"#a44");this.unit.mad=!0},onRemove:function(){this.unit.mad=!1},recalcStats:function(a){},update:function(){if(xb)return this.pow--,0>=this.pow}},rooting:{name:"rooted",bad:!0,init:function(){this.unit.say(m("rooted"),"#a44");this.initialTile=this.unit.tile;O(new rc(this.unit));bc("roots",this.unit,this.unit.tile.x+
.1,this.unit.tile.y,0)},onRemove:function(){},recalcStats:function(a){a.lockedTile=!0},update:function(){if(this.unit.tile!==this.initialTile)return!0;if(xb)return this.pow--,0>=this.pow}},poison:{name:"poisoned",bad:!0,init:b,onRemove:e,update:function(){if(ic)return this.pow--,0<this.pow&&0<this.unit.hp&&this.unit.damage(1),0>=this.pow}},paralize:{name:"paralized",bad:!0,init:b,onRemove:e,update:function(){0<this.unit.hp&&(this.unit.delay=20);if(Jb&&(this.pow--,1>this.pow))return this.unit.recalcSkinImages&&
this.unit.recalcSkinImages(),!0}},invisible:{name:"invisible",init:function(){this.unit.invisible=!0;this.unit.addOverMat("invisibility",1E3);O(new Na(this.unit))},onRemove:function(){this.unit.invisible=!1;this.unit.removeOverMat("invisibility")},update:function(){if(0>=this.unit.hp||Jb&&(this.pow--,1>this.pow))return!0}},stun:{name:"stunned",bad:!0,init:function(){var a=M(this.unit.x+8,this.unit.y+this.unit.uih,dd,fd);a.phase=this.pow;a.unit=this.unit},onRemove:function(){},update:function(){if(0>=
this.unit.hp)return!0;this.unit.delay=2;this.pow--;if(1>this.pow)return!0}}},c=function(a){a.recalcStats&&a.recalcStats()};X=function(b,e,f){if(!(0>=f)&&(e=d[e],0===a.filter(function(a){if(a.unit===b&&a.type===e)return a.pow=Math.max(f,a.pow),!0}).length)){var g={type:e,unit:b,pow:f};a.push(g);e.init&&e.init.call(g);c(b)}};var g=function(a){if(a.unit.tile&&a.type.update.call(a))a.type.onRemove&&a.type.onRemove.call(a),ka(c,1,a.unit);else return!0};Wc=function(){a=a.filter(g)};Tc=function(){a=[]};
var f,h=function(a){return a.unit===f};Ib=function(b){f=b;return a.filter(h)};var l=function(a){return a.unit===f&&a.type===q};vb=function(b,c){f=b;q=d[c];return a.some(l)};var p=function(a){if(a.type.bad&&a.unit===f)a.type.onRemove&&a.type.onRemove.call(a),ka(c,1,a.unit);else return!0};Pc=function(b){f=b;a=a.filter(p)};var q,r=function(a){if(a.type===q&&a.unit===f)a.type.onRemove&&a.type.onRemove.call(a),ka(c,1,a.unit);else return!0};Nc=function(b,c){f=b;q=d[c];a=a.filter(r)}})();"use strict";var ya,
pa,p,Ob,Pb,cc,uc="DEBUG";(function(){uc="0.7.1.54";$(".version").text("v"+uc);ab();setTimeout(bb,2500);try{screen.orientation.lock("landscape")}catch(k){}var a=document.getElementById("mapCanvas");p=a.getContext("2d");var b,e=function(){ya=window.innerWidth;pa=window.innerHeight;p.canvas.width=ya;p.canvas.height=pa;try{p.imageSmoothingEnabled=!1,p.mozImageSmoothingEnabled=!1,p.oImageSmoothingEnabled=!1,p.webkitImageSmoothingEnabled=!1,p.msImageSmoothingEnabled=!1}catch(k){}};window.addEventListener("resize",
function(){b&&(clearTimeout(b),b=!1);b=setTimeout(function(){b=!1;e()},400)});e();var d,c=20;setInterval(function(){if(!Ja()){d||(c=20,Ob=H("gameSpeed",0),Pb=H("battleSpeed",0),x.init(30,20),d=!0,Lc());var b;b=cc?Pb:Ob;cc=0;if(0<b)for(;0<=b;)x.update(),mc(),b--;else c++,c>-b&&(c=0,x.update(),mc());p.clearRect(0,0,a.width,a.height);x.draw();p.font=4*h+"px 'Russo One'";p.textAlign="center";Yc()}},1E3/60);ReactDOM.render(React.createElement(Hb),document.getElementById("ui"));ReactDOM.render(React.createElement(ad),
document.getElementById("modal"))})()})();